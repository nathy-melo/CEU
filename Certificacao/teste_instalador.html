<!DOCTYPE html>
<html>
<head>
    <title>Teste Instalador</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .row { margin: 8px 0; }
        button { margin: 4px 6px 4px 0; padding: 8px 14px; font-size: 14px; }
        input[type="text"], input[type="number"] { padding: 6px; font-size: 14px; }
        label { margin-right: 8px; }
        pre { background: #f5f5f5; padding: 15px; border: 1px solid #ddd; max-height: 60vh; overflow: auto; }
        .group { border: 1px solid #ddd; padding: 10px; margin: 10px 0; border-radius: 6px; }
        .group h2 { font-size: 16px; margin: 0 0 10px; }
    </style>
</head>
<body>
    <h1>Teste do Instalador</h1>

    <div class="group">
        <h2>Composer</h2>
        <div class="row">
            <button onclick="testarAcao('verificar_composer')">1. verificar_composer</button>
            <button onclick="testarAcao('instalar_composer')">2. instalar_composer</button>
            <button onclick="testarAcao('instalar_dependencias')">3. instalar_dependencias</button>
            <button onclick="testarAcao('verificar_instalacao')">4. verificar_instalacao</button>
        </div>
    </div>

    <div class="group">
        <h2>Git / Limpeza</h2>
        <div class="row">
            <button onclick="testarAcao('status_git')">status_git</button>
            <label><input type="checkbox" id="removerArtefatos"> remover composer.phar e instalador.log</label>
            <button onclick="limparInstalador()">limpar_instalador</button>
        </div>
    </div>

    <div class="group">
        <h2>Logs</h2>
        <div class="row">
            <input type="text" id="msgLog" placeholder="Mensagem do log" style="width: 320px;">
            <button onclick="criarLog()">criar_log</button>
        </div>
        <div class="row">
            <label for="linhas">Linhas:</label>
            <input type="number" id="linhas" value="200" min="1" max="2000">
            <button onclick="lerLog()">ler_log</button>
            <button onclick="testarAcao('limpar_log')">limpar_log</button>
        </div>
    </div>

    <div class="group">
        <h2>Auto Test</h2>
        <div class="row">
            <button onclick="testarAcao('auto_test')">auto_test</button>
        </div>
    </div>

    <pre id="resultado"></pre>
    
    <script>
        async function testarAcao(acao, body = '') {
            const resultado = document.getElementById('resultado');
            resultado.textContent = 'Testando ação: ' + acao + '...\n';
            try {
                const params = 'action=' + encodeURIComponent(acao) + (body ? '&' + body : '');
                const resp = await fetch('instalador.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                resultado.textContent += 'Status HTTP: ' + resp.status + '\n';
                resultado.textContent += 'Content-Type: ' + resp.headers.get('content-type') + '\n\n';
                const text = await resp.text();
                resultado.textContent += 'Resposta raw (' + text.length + ' caracteres):\n' + text + '\n\n';
                if (text.trim() === '') {
                    resultado.textContent += 'ERRO: Resposta vazia!\n';
                    return;
                }
                try {
                    const json = JSON.parse(text);
                    resultado.textContent += 'JSON:\n' + JSON.stringify(json, null, 2);
                } catch(e) {
                    resultado.textContent += 'ERRO ao parsear JSON: ' + e.message + '\n';
                    resultado.textContent += 'Primeiros 200 caracteres: ' + text.substring(0, 200);
                }
            } catch(e) {
                resultado.textContent += 'ERRO na requisição: ' + e.message;
            }
        }

        function limparInstalador() {
            const remover = document.getElementById('removerArtefatos').checked;
            testarAcao('limpar_instalador', 'remover_artefatos=' + (remover ? '1' : '0'));
        }

        function criarLog() {
            const msg = document.getElementById('msgLog').value.trim();
            if (!msg) { alert('Informe uma mensagem'); return; }
            testarAcao('criar_log', 'mensagem=' + encodeURIComponent(msg));
        }

        function lerLog() {
            const linhas = parseInt(document.getElementById('linhas').value || '200', 10);
            testarAcao('ler_log', 'linhas=' + encodeURIComponent(String(linhas)));
        }
    </script>
</body>
</html>
