<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - CEU</title>

    <meta name="description"
        content="Sistema de Gerenciamento Administrativo - CEU (Catálogo de Eventos Universitários)">
    <meta name="theme-color" content="#4F6C8C">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Admin CEU">
    <meta name="mobile-web-app-capable" content="yes">

    <link rel="icon" type="image/png" href="../Imagens/CEU-Logo-1x1.png" />
    <link rel="stylesheet" href="../styleGlobal.css" />
    <link rel="stylesheet" href="../styleGlobalMobile.css" media="(max-width: 767px)" />
    <link rel="stylesheet" href="styleAdmin.css">
    <style>
        body {
            display: block !important;
            justify-content: initial !important;
            align-items: initial !important;
        }

        .visually-hidden {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="admin-page-container">
        <div id="loadingScreen"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--fundo); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div style="text-align: center; color: var(--branco);">
                <div
                    style="width: 50px; height: 50px; border: 3px solid var(--caixas); border-top: 3px solid var(--botao); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;">
                </div>
                <p>Carregando painel administrativo...</p>
            </div>
        </div>

        <div id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h1><svg class="icon icon-medium" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
                    </svg> Painel Administrativo - CEU</h1>
                <p class="subtitle">Sistema de Gerenciamento Completo</p>
            </div>

            <div class="admin-container">

                <!-- Navegação -->
                <div class="admin-nav">
                    <button id="btnDashboard" class="btn-secondary active" onclick="showSection('dashboard')"><svg
                            class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                        </svg> Dashboard</button>
                    <button id="btnEventos" class="btn-secondary" onclick="showSection('eventos')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z" />
                        </svg> Eventos</button>
                    <button id="btnUsuarios" class="btn-secondary" onclick="showSection('usuarios')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg> Usuários</button>
                    <button id="btnCodigos" class="btn-secondary" onclick="showSection('codigos')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
                        </svg> Códigos</button>
                    <button id="btnCertificados" class="btn-secondary" onclick="showSection('certificados')"><svg
                            class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4zm16-8V4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" />
                        </svg> Certificados</button>
                    <button id="btnSenhas" class="btn-secondary" onclick="showSection('senhas')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                        </svg> Senhas</button>
                    <button id="btnBackups" class="btn-secondary" onclick="showSection('backups')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                        </svg> Backups</button>
                    <button id="btnPwarede" class="btn-secondary" onclick="showSection('pwarede')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4 4h16v2H4V4zm0 4h10v2H4V8zm0 4h16v2H4v-2zm0 4h10v2H4v-2zm14 0h2v6h-2v-6zM18 18l2-2 2 2h-4z" />
                        </svg> Rede/PWA</button>
                    <button id="btnSair" class="btn-secondary" onclick="logout()"
                        style="margin-left: auto; background: var(--vermelho);"><svg class="icon" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
                        </svg> Sair</button>
                </div>

                <!-- Dashboard -->
                <div id="dashboard" class="admin-section active">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                        </svg> Dashboard do Sistema</h3>
                    <div class="dashboard-grid">
                        <div class="stats-card" style="border-left-color: #28a745;">
                            <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z" />
                                </svg> Total de Eventos</h4>
                            <p id="totalEventos">-</p>
                            <small>Eventos cadastrados no sistema</small>
                        </div>
                        <div class="stats-card" style="border-left-color: var(--botao);">
                            <h4 style="color: var(--botao);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                                </svg> Total de Usuários</h4>
                            <p id="totalUsuarios">-</p>
                            <small>Usuários registrados</small>
                        </div>
                        <div class="stats-card" style="border-left-color: #ffc107;">
                            <h4 style="color: #ffc107;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                                </svg> Organizadores</h4>
                            <p id="totalOrganizadores">-</p>
                            <small>Usuários com perfil organizador</small>
                        </div>
                        <div class="stats-card" style="border-left-color: var(--vermelho);">
                            <h4 style="color: var(--vermelho);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
                                </svg> Códigos Ativos</h4>
                            <p id="totalCodigos">-</p>
                            <small>Códigos de organizador disponíveis</small>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                            </svg> Estatísticas Recentes</h4>
                        <div id="estatisticas">Carregando estatísticas...</div>
                    </div>
                </div>

                <!-- Gerenciamento de Eventos -->
                <div id="eventos" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z" />
                        </svg> Gerenciamento de Eventos</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="showModalEvento()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg> Novo Evento</button>
                        <button class="btn-secondary" onclick="carregarEventos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="exportarEventos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" />
                            </svg> Exportar</button>
                    </div>

                    <div class="admin-container" id="eventosContainer">
                        <p>Carregando eventos...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Usuários -->
                <div id="usuarios" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg> Gerenciamento de Usuários</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="showModalUsuario()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg> Novo Usuário</button>
                        <button class="btn-secondary" onclick="carregarUsuarios()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="exportarUsuarios()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" />
                            </svg> Exportar</button>
                        <label for="searchUsuarios" class="visually-hidden">Buscar usuários</label>
                        <input type="text" id="searchUsuarios" name="searchUsuarios"
                            placeholder="Buscar por nome, CPF ou email..." class="search-input" style="width: 350px;"
                            oninput="buscarUsuarios()" autocomplete="off">
                        <button class="clear-search" onclick="limparBuscaUsuarios()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg> Limpar</button>
                    </div>

                    <div class="admin-container" id="usuariosContainer">
                        <p>Carregando usuários...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Códigos -->
                <div id="codigos" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
                        </svg> Gerenciamento de Códigos</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="gerarNovoCodigo()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg> Gerar Código</button>
                        <button class="btn-secondary" onclick="carregarCodigos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="gerarCodigosLote()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                            </svg> Gerar em Lote</button>
                        <label for="searchCodigos" class="visually-hidden">Buscar códigos</label>
                        <input type="text" id="searchCodigos" name="searchCodigos" placeholder="Buscar código..."
                            class="search-input" style="width: 250px;" oninput="buscarCodigos()" autocomplete="off">
                        <button class="clear-search" onclick="limparBuscaCodigos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg> Limpar</button>
                    </div>

                    <div class="admin-container" id="codigosContainer">
                        <p>Carregando códigos...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Certificados -->
                <div id="certificados" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4zm16-8V4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" />
                        </svg> Gerenciamento de Certificados</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="carregarCertificados()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                    </div>

                    <div class="admin-container" id="certificadosContainer">
                        <p>Carregando certificados...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Solicitações de Senha -->
                <div id="senhas" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                        </svg> Gerenciamento de Redefinições de Senha</h3>

                    <div class="action-buttons" style="margin-top: 20px; margin-bottom: 20px;">
                        <button class="btn-secondary" onclick="carregarSolicitacoesSenha()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <div class="select-wrapper" style="flex: 1; max-width: 200px;">
                            <label for="filtroStatusSenha" class="visually-hidden">Filtrar por status</label>
                            <select id="filtroStatusSenha" class="search-input" style="width: 100%;"
                                onchange="carregarSolicitacoesSenha()">
                                <option value="all">Todos</option>
                                <option value="pendente" selected>Pendentes</option>
                                <option value="resolvida">Resolvidas</option>
                                <option value="cancelada">Canceladas</option>
                            </select>
                        </div>
                    </div>

                    <div class="admin-container" id="senhasContainer">
                        <p>Carregando solicitações...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Backups -->
                <div id="backups" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                        </svg> Gerenciamento de Backups</h3>

                    <div style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="carregarBackups()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                            </svg> Fazer Backup Agora</button>
                        <button class="btn-secondary" onclick="carregarListaBackups()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar Lista</button>
                    </div>

                    <div class="responsive-card-grid">
                        <div class="stats-card" style="border-left-color: var(--botao);">
                            <h4 style="color: var(--botao);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z" />
                                </svg> Tamanho BD</h4>
                            <p id="infoBDTamanho">-</p>
                        </div>
                        <div class="stats-card" style="border-left-color: #28a745;">
                            <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" />
                                </svg> Backups</h4>
                            <p id="infoBDTotal">0</p>
                        </div>
                    </div>

                    <div class="admin-container" id="backupsContainer">
                        <p>Carregando backups...</p>
                    </div>
                </div>

                <!-- PWA / Rede Diagnóstico -->
                <div id="pwarede" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 4a8 8 0 100 16 8 8 0 000-16zm1 9h5a6 6 0 01-5 5v-5zm-2 0v5a6 6 0 01-5-5h5zm0-2H6a6 6 0 015-5v5zm2 0V6a6 6 0 015 5h-5z" />
                        </svg> Diagnóstico de Rede e PWA</h3>

                    <div class="responsive-card-grid" id="pwaInfoGrid">
                        <div class="stats-card" style="border-left-color: var(--botao);">
                            <h4 style="color: var(--botao);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M6.62 10.79a15.534 15.534 0 006.59 6.59l2.2-2.2a1 1 0 011.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 011 1V21a1 1 0 01-1 1C10.85 22 2 13.15 2 2a1 1 0 011-1h3.5a1 1 0 011 1c0 1.25.2 2.46.57 3.58a1 1 0 01-.24 1.01l-2.2 2.2z" />
                                </svg> Acesso local</h4>
                            <p id="pwaLocalUrl">-</p>
                            <small>Use este endereço no celular para testar</small>
                        </div>
                        <div class="stats-card" style="border-left-color: #28a745;">
                            <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M12 2a10 10 0 100 20 10 10 0 000-20zm-1 15l-5-5 1.41-1.41L11 13.17l6.59-6.59L19 8l-8 9z" />
                                </svg> Service Worker</h4>
                            <p id="pwaSwStatus">-</p>
                            <small id="pwaSwScope">escopo: -</small>
                        </div>
                        <div class="stats-card" style="border-left-color: #ffc107;">
                            <h4 style="color: #ffc107;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h12v2H3v-2z" />
                                </svg> Manifesto</h4>
                            <p id="pwaManifestStatus">-</p>
                            <small id="pwaManifestHref">manifest: -</small>
                        </div>
                    </div>

                    <div class="admin-container" style="margin-top: 20px;">
                        <h4><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 7a2 2 0 110-4 2 2 0 010 4zm1 3h-2v7h2v-7z" />
                            </svg> Ações</h4>
                        <div class="action-buttons" style="display:flex; gap:10px; flex-wrap:wrap; margin: 10px 0;">
                            <button class="btn-secondary" onclick="desregistrarServiceWorkers()"><svg
                                    class="icon icon-small" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                                </svg> Desregistrar SW</button>
                            <button class="btn-secondary" onclick="limparCaches()"><svg class="icon icon-small"
                                    viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M20 6H4l-2 4v2h2v6a2 2 0 002 2h12a2 2 0 002-2v-6h2v-2l-2-4zm-4 12H8v-6h8v6zm-9-8l1-2h6l1 2H7z" />
                                </svg> Limpar Caches</button>
                            <button class="btn-secondary" onclick="verificarManifestos()"><svg class="icon icon-small"
                                    viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 7V3L7 8l5 5V9c3.31 0 6 2.69 6 6 0 1.1-.3 2.13-.82 3.02l1.46 1.46A7.932 7.932 0 0020 15c0-4.42-3.58-8-8-8z" />
                                </svg> Revalidar Status</button>
                            <a class="btn-secondary" href="/CEU/Admin/teste-pwa.html" target="_blank"
                                rel="noopener"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M14 3v2H5v14h14v-9h2v11H3V3h11zm7 0h-6v2h2.59L10 12.59 11.41 14 19 6.41V9h2V3z" />
                                </svg> Abrir Teste PWA</a>
                        </div>

                        <div id="pwaDetalhes"
                            style="background:#f8f9fa; border:1px solid #dee2e6; border-radius:8px; padding:12px; font-family:monospace; white-space:pre-wrap;">
                            Coletando informações...
                        </div>
                    </div>

                    <div class="admin-container" style="margin-top: 20px;">
                        <h4><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2a10 10 0 00-9 5.5L5 9a8 8 0 111 8l-2 1.5A10 10 0 1012 2z" />
                            </svg> Ajuda de Firewall e Rede</h4>
                        <p>
                            Para acessar no celular, conecte ao mesmo Wi-Fi e use o endereço local acima.
                            Se não abrir, verifique o Firewall do Windows e libere o Apache (porta 80). Consulte:
                        </p>
                        <ul>
                            <li><a href="/CEU/Admin/FIREWALL-SOLUCAO.md" target="_blank" rel="noopener">Guia:
                                    FIREWALL-SOLUCAO.md</a></li>
                            <li><a href="/CEU/Admin/firewall-control.bat" download>Script .bat para abrir regras
                                    (download)</a></li>
                        </ul>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal para Eventos -->
    <div id="modalEvento"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div class="admin-container">
            <h3 id="modalEventoTitle">Novo Evento</h3>
            <form id="formEvento">
                <div class="responsive-grid">
                    <div class="form-group">
                        <label for="cod_evento">Código do Evento:</label>
                        <input type="number" id="cod_evento" name="cod_evento" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria:</label>
                        <select id="categoria" name="categoria" required autocomplete="off">
                            <option value="">Selecione...</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Palestra">Palestra</option>
                            <option value="Curso">Curso</option>
                            <option value="Semana">Semana</option>
                            <option value="Minicurso">Minicurso</option>
                            <option value="Hackathon">Hackathon</option>
                            <option value="Conferencia">Conferência</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="nome">Nome do Evento:</label>
                        <input type="text" id="nome" name="nome" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="lugar">Local:</label>
                        <input type="text" id="lugar" name="lugar" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="modalidade">Modalidade:</label>
                        <select id="modalidade" name="modalidade" required autocomplete="off">
                            <option value="Presencial">Presencial</option>
                            <option value="Online">Online</option>
                            <option value="Híbrido">Híbrido</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2;">
                        <label for="descricao">Descrição:</label>
                        <textarea id="descricao" name="descricao"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px;"
                            autocomplete="off"></textarea>
                    </div>
                    <div>
                        <label for="publico_alvo">Público Alvo:</label>
                        <input type="text" id="publico_alvo" name="publico_alvo"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div>
                        <label for="duracao">Duração (horas):</label>
                        <input type="number" step="0.5" id="duracao" name="duracao"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div>
                        <label for="inicio">Data/Hora Início:</label>
                        <input type="datetime-local" id="inicio" name="inicio" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div>
                        <label for="conclusao">Data/Hora Fim:</label>
                        <input type="datetime-local" id="conclusao" name="conclusao" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div style="grid-column: span 2;">
                        <label for="certificado">
                            <input type="checkbox" id="certificado" name="certificado" value="1"> Gera Certificado
                        </label>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn-generate">Salvar Evento</button>
                    <button type="button" class="btn-secondary" onclick="fecharModalEvento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Usuários -->
    <div id="modalUsuario"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div class="admin-container">
            <h3 id="modalUsuarioTitle">Novo Usuário</h3>
            <form id="formUsuario">
                <div class="responsive-grid">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="usuario_cpf">CPF: *</label>
                        <input type="text" id="usuario_cpf" name="cpf" required
                            placeholder="Apenas números (11 dígitos)" maxlength="11" pattern="[0-9]{11}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                        <small style="color: #ffffff;">Digite apenas números, sem pontos ou traços</small>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="usuario_nome">Nome Completo: *</label>
                        <input type="text" id="usuario_nome" name="nome" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="usuario_email">Email: *</label>
                        <input type="email" id="usuario_email" name="email" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="usuario_senha">Senha: *</label>
                        <input type="password" id="usuario_senha" name="senha" required minlength="6"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="new-password">
                        <small style="color: #ffffff;">Mínimo 6 caracteres</small>
                    </div>
                    <div class="form-group">
                        <label for="usuario_confirma_senha">Confirmar Senha: *</label>
                        <input type="password" id="usuario_confirma_senha" name="confirma_senha" required minlength="6"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="usuario_ra">RA: (opcional)</label>
                        <input type="text" id="usuario_ra" name="ra" placeholder="7 dígitos" maxlength="7"
                            pattern="[0-9]{7}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="usuario_organizador">Tipo de Usuário:</label>
                        <select id="usuario_organizador" name="organizador" onchange="toggleCodigoOrganizador()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                            <option value="0">Participante</option>
                            <option value="1">Organizador</option>
                        </select>
                    </div>
                    <div class="form-group" id="codigoOrganizadorField" style="grid-column: span 2; display: none;">
                        <label for="usuario_codigo">Código de Organizador: *</label>
                        <input type="text" id="usuario_codigo" name="codigo" placeholder="8 caracteres" maxlength="8"
                            pattern="[A-Z0-9]{8}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-transform: uppercase;"
                            autocomplete="off">
                        <small style="color: #ffffff;">Código de 8 caracteres para organizador</small>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn-generate"><svg class="icon icon-small" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                        </svg> Salvar Usuário</button>
                    <button type="button" class="btn-secondary" onclick="fecharModalUsuario()"><svg
                            class="icon icon-small" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z" />
                        </svg> Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gerenciamento de Códigos -->
    <div id="codes" class="admin-section">
        <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
            </svg> Gerenciamento de Códigos</h3>

        <div style="margin-bottom: 20px;">
            <button class="btn-generate" onclick="gerarNovoCodigo()"><svg class="icon icon-small" viewBox="0 0 24 24"
                    fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg> Gerar Novo Código</button>
            <button class="btn-secondary" onclick="carregarCodigos()"><svg class="icon icon-small" viewBox="0 0 24 24"
                    fill="currentColor">
                    <path
                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg> Atualizar Lista</button>
        </div>

        <div id="codigosList" style="background: white; border-radius: 10px; padding: 20px;">
            <p>Carregando códigos...</p>
        </div>
    </div>

    <!-- Área de Teste -->
    <div id="test" class="admin-section">
        <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M20 2H4c-1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
            </svg> Área de Teste</h3>

        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h4>Teste de Funcionalidades</h4>

            <div style="margin: 15px 0;">
                <button class="btn-test" onclick="testarConexaoBD()"><svg class="icon icon-small" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z" />
                    </svg> Testar Banco de Dados</button>
                <button class="btn-test" onclick="testarSessao()"><svg class="icon icon-small" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                    </svg> Testar Sessão</button>
                <button class="btn-test" onclick="testarLogs()"><svg class="icon icon-small" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                    </svg> Verificar Logs</button>
            </div>

            <div id="testResults"
                style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; min-height: 100px; margin-top: 15px;">
                Clique em um dos botões acima para executar testes.
            </div>
        </div>
    </div>

    </div>
    </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .admin-nav button.active {
            background: #28a745 !important;
            transform: scale(1.05);
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--botao);
        }

        .data-table th {
            background-color: var(--botao);
            font-weight: bold;
        }

        .data-table tr:hover {
            background-color: var(--botao);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-ativo {
            background: #d4edda;
            color: #155724;
        }

        .status-inativo {
            background: #f8d7da;
            color: #721c24;
        }

        .status-usado {
            background: #fff3cd;
            color: #856404;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin: 2px;
        }

        .btn-edit {
            background: #4F6C8C;
            color: white;
        }

        .btn-delete {
            background: var(--vermelho);
            color: white;
        }

        .btn-toggle {
            background: #4F6C8C;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-download:hover {
            background: #28a745;
        }

        .btn-restore {
            background: #ffc107;
            color: #212529;
        }

        .btn-restore:hover {
            background: #e0a800;
        }

        /* Estilos para campos de busca */
        .search-input {
            padding: 10px 15px 10px 15px !important;
            border: 2px solid #e3e6f0 !important;
            border-radius: 25px !important;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            border-color: #6598D2 !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
            outline: none;
        }

        .search-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }

        .clear-search {
            background: #6c757d !important;
            color: white !important;
            border: none !important;
            padding: 8px 12px !important;
            border-radius: 20px !important;
            font-size: 12px !important;
            margin-left: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-search:hover {
            background: #545b62 !important;
        }

        .search-results-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
            color: #495057;
            border-left: 4px solid #6598D2;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            font-style: italic;
        }
    </style>

    <script>
        let currentData = {};

        // Verificar autenticação ao carregar
        document.addEventListener('DOMContentLoaded', function () {
            verificarAuth();
        });

        function verificarAuth() {
            const tempAuth = localStorage.getItem('admin_temp_auth');

            if (!tempAuth) {
                console.log('Sem credenciais temporárias, redirecionando...');
                window.location.href = 'LoginAdmin.html';
                return;
            }

            // Decodificar e verificar
            try {
                const decoded = atob(tempAuth);
                const [usuario, senha] = decoded.split(':');

                if (usuario === 'infofriends' && senha === '12345678') {
                    console.log('Credenciais válidas, mostrando painel...');
                    // Criar sessão no servidor para o PHP
                    fetch('GerenciadorAdmin.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ admin_temp_auth: tempAuth })
                    }).then(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        carregarDashboard();
                    });
                } else {
                    throw new Error('Credenciais inválidas');
                }
            } catch (error) {
                console.error('Erro na verificação:', error);
                localStorage.removeItem('admin_temp_auth');
                window.location.href = 'LoginAdmin.html';
            }
        }

        // Função auxiliar para fazer requisições à API
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            // Adicionar timestamp para evitar cache
            const timestamp = new Date().getTime();
            const baseUrl = `GerenciadorAdmin.php?action=${endpoint}`;
            const url = `${baseUrl}&_t=${timestamp}`;

            try {
                const response = await fetch(url, options);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                return result;
            } catch (error) {
                console.error('Erro na API:', error);
                alert('Erro: ' + error.message);
                throw error;
            }
        }

        function showSection(sectionId) {
            // Ocultar todas as seções
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => section.classList.remove('active'));

            // Remover active de todos os botões
            const buttons = document.querySelectorAll('.admin-nav button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Mostrar seção selecionada
            document.getElementById(sectionId).classList.add('active');
            const buttonId = 'btn' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            const button = document.getElementById(buttonId);
            if (button) button.classList.add('active');

            // Carregar dados específicos da seção
            switch (sectionId) {
                case 'dashboard':
                    carregarDashboard();
                    break;
                case 'eventos':
                    carregarEventos();
                    break;
                case 'usuarios':
                    carregarUsuarios();
                    break;
                case 'codigos':
                    carregarCodigos();
                    break;
                case 'certificados':
                    carregarCertificados();
                    break;
                case 'senhas':
                    carregarSolicitacoesSenha();
                    break;
                case 'backups':
                    carregarInfoBackups();
                    carregarListaBackups();
                    break;
                case 'pwarede':
                    carregarPwaRede();
                    break;
            }
        }

        // =======================================
        // DASHBOARD
        // =======================================

        async function carregarDashboard() {
            try {
                const result = await apiCall('dashboard');
                const stats = result.data;

                document.getElementById('totalEventos').textContent = stats.eventos;
                document.getElementById('totalUsuarios').textContent = stats.usuarios;
                document.getElementById('totalOrganizadores').textContent = stats.organizadores;
                document.getElementById('totalCodigos').textContent = stats.codigos;

                // Estatísticas detalhadas
                let html = '<h5>Eventos por Categoria</h5>';
                html += '<div class="responsive-card-grid">';

                stats.eventos_por_categoria.forEach(cat => {
                    html += `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                        <strong>${cat.categoria}</strong><br>
                        <span style="font-size: 20px; color: #6598D2;">${cat.total}</span>
                    </div>`;
                });

                html += '</div><h5>Últimos Eventos</h5><ul>';

                stats.ultimos_eventos.forEach(evento => {
                    const data = new Date(evento.inicio).toLocaleDateString();
                    html += `<li><strong>${evento.nome}</strong> - ${data} (${evento.modalidade})</li>`;
                });

                html += '</ul>';

                document.getElementById('estatisticas').innerHTML = html;

            } catch (error) {
                document.getElementById('estatisticas').innerHTML = '<p style="color: red;">Erro ao carregar estatísticas.</p>';
            }
        }

        // =======================================
        // EVENTOS
        // =======================================

        async function carregarEventos() {
            try {
                const result = await apiCall('eventos');
                currentData.eventos = result.data;
                renderizarEventos(currentData.eventos);
            } catch (error) {
                document.getElementById('eventosContainer').innerHTML = '<p style="color: red;">Erro ao carregar eventos.</p>';
            }
        }

        function renderizarEventos(eventos) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            let html = '';

            if (!isMobile) {
                html += '<div class="table-wrapper"><table class="admin-table">';
                html += '<thead><tr><th>ID</th><th>Nome</th><th>Categoria</th><th>Data Início</th><th>Local</th><th>Modalidade</th><th>Certificado</th><th>Ações</th></tr></thead><tbody>';

                if (!eventos || eventos.length === 0) {
                    html += '<tr><td colspan="8" style="text-align:center; padding:20px; color:#999;">Nenhum evento encontrado</td></tr>';
                } else {
                    eventos.forEach(evento => {
                        const dataInicio = new Date(evento.inicio).toLocaleDateString('pt-BR');
                        const certificado = evento.certificado ? 'Sim' : 'Não';
                        html += `<tr>
                            <td>${evento.cod_evento}</td>
                            <td><strong>${evento.nome}</strong></td>
                            <td>${evento.categoria}</td>
                            <td>${dataInicio}</td>
                            <td>${evento.lugar}</td>
                            <td>${evento.modalidade}</td>
                            <td>${certificado}</td>
                            <td>
                                <button class="btn-small btn-edit" onclick="editarEvento(${evento.cod_evento})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Editar</button>
                                <button class="btn-small btn-delete" onclick="excluirEvento(${evento.cod_evento})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Excluir</button>
                            </td>
                        </tr>`;
                    });
                }

                html += '</tbody></table></div>';
            } else {
                html += '<div class="mobile-cards-container">';

                if (!eventos || eventos.length === 0) {
                    html += '<p style="text-align:center; padding:20px; color:#999;">Nenhum evento encontrado</p>';
                } else {
                    eventos.forEach(evento => {
                        const dataInicio = new Date(evento.inicio).toLocaleDateString('pt-BR');
                        html += `<div class="mobile-card">
                            <div class="mobile-card-row"><span class="mobile-card-label">ID</span><span class="mobile-card-value">#${evento.cod_evento}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Nome</span><span class="mobile-card-value"><strong>${evento.nome}</strong></span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Categoria</span><span class="mobile-card-value">${evento.categoria}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Início</span><span class="mobile-card-value">${dataInicio}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Local</span><span class="mobile-card-value">${evento.lugar}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Modalidade</span><span class="mobile-card-value">${evento.modalidade}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Certificado</span><span class="mobile-card-value">${evento.certificado ? 'Sim' : 'Não'}</span></div>
                            <div class="mobile-card-actions">
                                <button class="btn-small btn-edit" onclick="editarEvento(${evento.cod_evento})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d=\"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z\"/></svg> Editar</button>
                                <button class="btn-small btn-delete" onclick="excluirEvento(${evento.cod_evento})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d=\"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z\"/></svg> Excluir</button>
                            </div>
                        </div>`;
                    });
                }

                html += '</div>';
            }

            html += `<div class="search-results-info">Mostrando ${eventos ? eventos.length : 0} eventos</div>`;
            document.getElementById('eventosContainer').innerHTML = html;

            window.__lastEventosIsMobile = isMobile;
            if (!window.__eventosResizeAttached) {
                window.__eventosResizeAttached = true;
                window.addEventListener('resize', () => {
                    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (nowMobile !== window.__lastEventosIsMobile && currentData.eventos) {
                        window.__lastEventosIsMobile = nowMobile;
                        renderizarEventos(currentData.eventos);
                    }
                });
            }
        }

        // =======================================
        // USUÁRIOS
        // =======================================

        async function carregarUsuarios() {
            try {
                // Limpar dados antigos para forçar reload
                currentData.usuarios = [];

                // Mostrar loading
                document.getElementById('usuariosContainer').innerHTML = '<p>🔄️ Carregando usuários...</p>';

                const result = await apiCall('usuarios');
                currentData.usuarios = result.data;

                // Usa a nova função de renderização
                renderizarUsuarios(currentData.usuarios);

                console.log('Usuários carregados:', currentData.usuarios.length);

            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                document.getElementById('usuariosContainer').innerHTML = '<p style="color: red;">Erro ao carregar usuários.</p>';
            }
        }

        // =======================================
        // CÓDIGOS
        // =======================================

        async function carregarCodigos() {
            try {
                // Limpar dados antigos para forçar reload
                currentData.codigos = [];

                // Mostrar loading
                document.getElementById('codigosContainer').innerHTML = '<p>🔄️ Carregando códigos...</p>';

                const result = await apiCall('codigos');
                currentData.codigos = result.data;

                // Usa a nova função de renderização
                renderizarCodigos(currentData.codigos);

                console.log('Códigos carregados:', currentData.codigos.length);

            } catch (error) {
                console.error('Erro ao carregar códigos:', error);
                document.getElementById('codigosContainer').innerHTML = '<p style="color: red;">Erro ao carregar códigos.</p>';
            }
        }

        // =======================================
        // CERTIFICADOS
        // =======================================

        async function carregarCertificados() {
            try {
                const result = await apiCall('certificados');
                currentData.certificados = result.data;
                renderizarCertificados(currentData.certificados);
            } catch (error) {
                document.getElementById('certificadosContainer').innerHTML = '<p style="color: red;">Erro ao carregar certificados.</p>';
            }
        }

        function renderizarCertificados(certificados) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            let html = '';

            if (!isMobile) {
                html += '<div class="table-wrapper"><table class="admin-table">';
                html += '<thead><tr><th>Código Verificação</th><th>Modelo</th><th>Tipo</th><th>Ações</th></tr></thead><tbody>';
                if (!certificados || certificados.length === 0) {
                    html += '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">Nenhum certificado encontrado</td></tr>';
                } else {
                    certificados.forEach(cert => {
                        html += `<tr>
                            <td><strong>${cert.cod_verificacao}</strong></td>
                            <td>${cert.modelo}</td>
                            <td>${cert.tipo}</td>
                            <td>
                                <button class="btn-small btn-edit" onclick="validarCertificado('${cert.cod_verificacao}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z\"/></svg> Validar</button>
                            </td>
                        </tr>`;
                    });
                }
                html += '</tbody></table></div>';
            } else {
                html += '<div class="mobile-cards-container">';
                if (!certificados || certificados.length === 0) {
                    html += '<p style="text-align:center; padding:20px; color:#999;">Nenhum certificado encontrado</p>';
                } else {
                    certificados.forEach(cert => {
                        html += `<div class="mobile-card">
                            <div class="mobile-card-row"><span class="mobile-card-label">Código</span><span class="mobile-card-value"><strong>${cert.cod_verificacao}</strong></span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Modelo</span><span class="mobile-card-value">${cert.modelo}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Tipo</span><span class="mobile-card-value">${cert.tipo}</span></div>
                            <div class="mobile-card-actions">
                                <button class="btn-small btn-edit" onclick="validarCertificado('${cert.cod_verificacao}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d=\"M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z\"/></svg> Validar</button>
                            </div>
                        </div>`;
                    });
                }
                html += '</div>';
            }

            html += `<div class=\"search-results-info\">Mostrando ${certificados ? certificados.length : 0} certificados</div>`;
            document.getElementById('certificadosContainer').innerHTML = html;

            window.__lastCertificadosIsMobile = isMobile;
            if (!window.__certificadosResizeAttached) {
                window.__certificadosResizeAttached = true;
                window.addEventListener('resize', () => {
                    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (nowMobile !== window.__lastCertificadosIsMobile && currentData.certificados) {
                        window.__lastCertificadosIsMobile = nowMobile;
                        renderizarCertificados(currentData.certificados);
                    }
                });
            }
        }

        // =======================================
        // AÇÕES DOS BOTÕES
        // =======================================

        async function gerarNovoCodigo() {
            // Pergunta se quer gerar automaticamente ou inserir manualmente
            const opcao = confirm('GERAÇÃO DE CÓDIGO\n\nOK = Gerar código automático (seguro)\nCancelar = Inserir código manualmente');

            let codigo = '';
            if (!opcao) {
                // Modo manual
                codigo = prompt('CÓDIGO MANUAL\n\nDigite o código (exatamente 8 caracteres):\n• Letras: A-Z (exceto I, O)\n• Números: 2-9 (exceto 0, 1)\n\nExemplo: AB3C5XYZ');
                if (!codigo) return; // Cancelou

                codigo = codigo.toUpperCase().trim();
                if (codigo.length !== 8) {
                    alert('ERRO: O código deve ter exatamente 8 caracteres!\n\nVocê digitou: ' + codigo.length + ' caracteres');
                    return;
                }

                if (!/^[ABCDEFGHJKLMNPQRSTUVWXYZ23456789]{8}$/.test(codigo)) {
                    alert('FORMATO INVÁLIDO!\n\nUse apenas:\n• Letras: A, B, C, D, E, F, G, H, J, K, L, M, N, P, Q, R, S, T, U, V, W, X, Y, Z\n• Números: 2, 3, 4, 5, 6, 7, 8, 9\n\n(Sem: I, O, 0, 1)');
                    return;
                }
            }

            // Pergunta pelas observações SEPARADAMENTE
            const observacoes = prompt('OBSERVAÇÕES (opcional)\n\nDescreva o propósito deste código:\n(deixe vazio se não quiser observações)') || '';

            try {
                const payload = { observacoes };
                if (codigo) {
                    payload.codigo = codigo;
                    console.log('Enviando código manual:', codigo);
                } else {
                    console.log('Gerando código automático');
                }

                console.log('Payload completo:', payload);

                const response = await apiCall('codigos', 'POST', payload);
                alert('CÓDIGO CRIADO COM SUCESSO!\n\nCódigo: ' + response.codigo + '\nObservações: ' + (observacoes || 'Nenhuma') + '\n\nEste código é único e seguro!');
                carregarCodigos();
            } catch (error) {
                console.error('Erro ao criar código:', error);
                alert('Erro ao criar código. Verifique o console para detalhes.');
            }
        }

        async function toggleCodigo(id, novoStatus) {
            try {
                // Garantir que novoStatus seja um boolean válido
                const ativo = Boolean(novoStatus);
                const action = ativo ? 'ativar' : 'desativar';

                if (confirm(`Confirma ${action} este código?`)) {
                    await apiCall('codigos', 'PUT', {
                        id: parseInt(id),
                        ativo: ativo,
                        observacoes: ''
                    });
                    alert(`Código ${ativo ? 'ativado' : 'desativado'} com sucesso!`);
                    carregarCodigos();
                }
            } catch (error) {
                console.error('Erro ao alterar status do código:', error);
                alert('Erro ao alterar status do código');
            }
        }

        async function excluirCodigo(id) {
            if (confirm('Tem certeza que deseja excluir este código?')) {
                try {
                    await apiCall(`codigos&id=${id}`, 'DELETE');
                    carregarCodigos();
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            }
        }

        async function toggleOrganizador(cpf, novoStatus) {
            let codigo = null;
            if (novoStatus) {
                codigo = prompt('Digite o código de organizador para este usuário:');
                if (!codigo) return;
            }

            try {
                await apiCall('usuarios', 'PUT', { CPF: cpf, Organizador: novoStatus, Codigo: codigo });
                carregarUsuarios();
            } catch (error) {
                // Erro já tratado na função apiCall
            }
        }

        async function excluirUsuario(cpf) {
            if (confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
                try {
                    await apiCall(`usuarios&id=${cpf}`, 'DELETE');
                    carregarUsuarios();
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            }
        }

        async function excluirEvento(id) {
            if (confirm('Tem certeza que deseja excluir este evento?')) {
                try {
                    await apiCall(`eventos&id=${id}`, 'DELETE');
                    carregarEventos();
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            }
        }

        // =======================================
        // MODAL DE EVENTOS
        // =======================================

        function showModalEvento(eventoId = null) {
            document.getElementById('modalEvento').style.display = 'block';

            if (eventoId) {
                // Editar evento existente
                const evento = currentData.eventos.find(e => e.cod_evento == eventoId);
                if (evento) {
                    document.getElementById('modalEventoTitle').textContent = 'Editar Evento';
                    document.getElementById('cod_evento').value = evento.cod_evento;
                    // Código do evento como somente leitura na edição
                    document.getElementById('cod_evento').readOnly = true;
                    document.getElementById('cod_evento').classList.add('readonly-input');
                    document.getElementById('categoria').value = evento.categoria;
                    document.getElementById('nome').value = evento.nome;
                    document.getElementById('lugar').value = evento.lugar;
                    document.getElementById('modalidade').value = evento.modalidade;
                    document.getElementById('descricao').value = evento.descricao;
                    document.getElementById('publico_alvo').value = evento.publico_alvo;
                    document.getElementById('duracao').value = evento.duracao;
                    document.getElementById('inicio').value = evento.inicio.slice(0, 16);
                    document.getElementById('conclusao').value = evento.conclusao.slice(0, 16);
                    document.getElementById('certificado').checked = evento.certificado == 1;
                }
            } else {
                // Novo evento
                document.getElementById('modalEventoTitle').textContent = 'Novo Evento';
                document.getElementById('formEvento').reset();
                // Reativar edição do código do evento
                document.getElementById('cod_evento').readOnly = false;
                document.getElementById('cod_evento').classList.remove('readonly-input');
            }
        }

        function fecharModalEvento() {
            document.getElementById('modalEvento').style.display = 'none';
            // Limpar estado readonly ao fechar para evitar persistência inesperada
            const cod = document.getElementById('cod_evento');
            if (cod) { cod.readOnly = false; cod.classList.remove('readonly-input'); }
        }

        function editarEvento(id) {
            showModalEvento(id);
        }

        // =======================================
        // MODAL DE USUÁRIOS
        // =======================================

        function showModalUsuario() {
            document.getElementById('modalUsuario').style.display = 'block';
            document.getElementById('modalUsuarioTitle').textContent = 'Novo Usuário';
            document.getElementById('formUsuario').reset();
            document.getElementById('codigoOrganizadorField').style.display = 'none';
            document.getElementById('usuario_codigo').required = false;
        }

        function fecharModalUsuario() {
            document.getElementById('modalUsuario').style.display = 'none';
        }

        function toggleCodigoOrganizador() {
            const organizador = document.getElementById('usuario_organizador').value;
            const codigoField = document.getElementById('codigoOrganizadorField');
            const codigoInput = document.getElementById('usuario_codigo');

            if (organizador === '1') {
                codigoField.style.display = 'block';
                codigoInput.required = true;
            } else {
                codigoField.style.display = 'none';
                codigoInput.required = false;
                codigoInput.value = '';
            }
        }

        async function criarUsuario(data) {
            try {
                await apiCall('usuarios', 'POST', data);
                fecharModalUsuario();
                carregarUsuarios();
                alert('Usuário criado com sucesso!');
            } catch (error) {
                console.error('Erro ao criar usuário:', error);
            }
        }

        // Form submission
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('formEvento').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Adicionar campos não capturados pelo FormData
                data.cod_evento = document.getElementById('cod_evento').value;
                data.categoria = document.getElementById('categoria').value;
                data.nome = document.getElementById('nome').value;
                data.lugar = document.getElementById('lugar').value;
                data.modalidade = document.getElementById('modalidade').value;
                data.descricao = document.getElementById('descricao').value;
                data.publico_alvo = document.getElementById('publico_alvo').value;
                data.duracao = document.getElementById('duracao').value;
                data.inicio = document.getElementById('inicio').value;
                data.conclusao = document.getElementById('conclusao').value;
                data.certificado = document.getElementById('certificado').checked;

                try {
                    // Verificar se é edição ou criação
                    const isEdit = currentData.eventos && currentData.eventos.some(e => e.cod_evento == data.cod_evento);

                    if (isEdit) {
                        await apiCall('eventos', 'PUT', data);
                    } else {
                        await apiCall('eventos', 'POST', data);
                    }

                    fecharModalEvento();
                    carregarEventos();
                    alert('Evento salvo com sucesso!');
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            });

            // Form submission para Usuário
            document.getElementById('formUsuario').addEventListener('submit', async function (e) {
                e.preventDefault();

                // Validar senhas
                const senha = document.getElementById('usuario_senha').value;
                const confirmaSenha = document.getElementById('usuario_confirma_senha').value;

                if (senha !== confirmaSenha) {
                    alert('As senhas não coincidem!');
                    return;
                }

                // Validar CPF (11 dígitos)
                const cpf = document.getElementById('usuario_cpf').value;
                if (!/^\d{11}$/.test(cpf)) {
                    alert('CPF deve conter exatamente 11 dígitos numéricos!');
                    return;
                }

                // Validar RA (7 dígitos ou vazio)
                const ra = document.getElementById('usuario_ra').value;
                if (ra && !/^\d{7}$/.test(ra)) {
                    alert('RA deve conter exatamente 7 dígitos numéricos ou ser deixado em branco!');
                    return;
                }

                const formData = new FormData(this);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    if (key !== 'confirma_senha') { // Não enviar confirmação de senha
                        data[key] = value;
                    }
                }

                // Converter organizador para número
                data.organizador = parseInt(data.organizador);

                try {
                    await apiCall('usuarios', 'POST', data);
                    fecharModalUsuario();
                    carregarUsuarios();
                    alert('Usuário criado com sucesso!');
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            });
        });

        function exportarEventos() {
            alert('Funcionalidade de exportação será implementada em breve.');
        }

        function exportarUsuarios() {
            alert('Funcionalidade de exportação será implementada em breve.');
        }

        function gerarCodigosLote() {
            const quantidade = prompt('Quantos códigos deseja gerar?');
            if (quantidade && parseInt(quantidade) > 0) {
                alert(`Funcionalidade de geração em lote será implementada. Solicitado: ${quantidade} códigos.`);
            }
        }

        function validarCertificados() {
            alert('Funcionalidade de validação será implementada em breve.');
        }

        function validarCertificado(codigo) {
            alert(`Validando certificado: ${codigo}`);
        }

        // =======================================
        // SOLICITAÇÕES DE SENHA
        // =======================================

        async function carregarSolicitacoesSenha() {
            try {
                const filtroStatus = document.getElementById('filtroStatusSenha')?.value || 'pendente';

                // Mostrar loading
                document.getElementById('senhasContainer').innerHTML = '<p>🔄️ Carregando solicitações...</p>';

                const result = await apiCall(`senhas&status=${filtroStatus}`);
                currentData.senhas = result.data;
                // Guardar meta para re-render por resize
                currentData.senhasMeta = result.meta || {};

                renderizarSolicitacoesSenha(currentData.senhas, currentData.senhasMeta);

                console.log('Solicitações de senha carregadas:', currentData.senhas.length);

            } catch (error) {
                console.error('Erro ao carregar solicitações:', error);
                document.getElementById('senhasContainer').innerHTML = '<p style="color: red;">Erro ao carregar solicitações.</p>';
            }
        }

        function renderizarSolicitacoesSenha(solicitacoes, meta = {}) {
            let html = '';
            const isMobile = window.matchMedia('(max-width: 768px)').matches;

            // Mostrar estatísticas
            if (meta.totais_por_status) {
                html += '<div class="responsive-card-grid">';
                html += `<div class="stats-card" style="border-left-color: #ffc107;">
                    <h4 style="color: #ffc107;"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> Pendentes</h4>
                    <p>${meta.totais_por_status.pendente || 0}</p>
                </div>`;
                html += `<div class="stats-card" style="border-left-color: #28a745;">
                    <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Resolvidas</h4>
                    <p>${meta.totais_por_status.resolvida || 0}</p>
                </div>`;
                html += `<div class="stats-card" style="border-left-color: var(--vermelho);">
                    <h4 style="color: var(--vermelho);"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Canceladas</h4>
                    <p>${meta.totais_por_status.cancelada || 0}</p>
                </div>`;
                html += '</div>';
            }

            if (!isMobile) {
                // TABELA (Desktop)
                html += '<div class="table-wrapper"><table class="admin-table">';
                html += '<thead><tr><th>ID</th><th>Email</th><th>Nome Usuário</th><th>CPF</th><th>Data Solicitação</th><th>Status</th><th>Ações</th></tr></thead><tbody>';

                if (solicitacoes.length === 0) {
                    html += '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Nenhuma solicitação encontrada</td></tr>';
                } else {
                    solicitacoes.forEach(solicitacao => {
                        const dataSolicitacao = new Date(solicitacao.data_solicitacao).toLocaleString('pt-BR');
                        let statusBadge = `<span class="status-badge ${solicitacao.status}">${solicitacao.status}</span>`;

                        const nomeUsuario = solicitacao.nome_usuario || '<em>Usuário não encontrado</em>';
                        const cpf = solicitacao.CPF || '<em>N/A</em>';

                        html += `<tr>
                            <td>${solicitacao.id}</td>
                            <td><strong>${solicitacao.email}</strong></td>
                            <td>${nomeUsuario}</td>
                            <td>${cpf}</td>
                            <td>${dataSolicitacao}</td>
                            <td>${statusBadge}</td>
                            <td>`;

                        if (solicitacao.status === 'pendente') {
                            const nomeEsc = (solicitacao.nome_usuario || '').replace(/'/g, "\\'");
                            const emailEsc = (solicitacao.email || '').replace(/'/g, "\\'");
                            const cpfEsc = (solicitacao.CPF || '').replace(/'/g, "\\'");
                            html += `<button class="btn-small btn-edit" onclick="modalRedefinirSenha(${solicitacao.id}, '${cpfEsc}', '${emailEsc}', '${nomeEsc}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg> Redefinir</button> `;
                        }

                        if (solicitacao.status === 'pendente') {
                            html += `<button class="btn-small btn-delete" onclick="cancelarSolicitacaoSenha(${solicitacao.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Cancelar</button>`;
                        }

                        if (solicitacao.status === 'resolvida' && solicitacao.observacoes) {
                            html += `<button class="btn-small btn-toggle" onclick="verObservacoesPorId(${solicitacao.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Ver Obs</button>`;
                        }

                        html += `</td></tr>`;
                    });
                }

                html += '</tbody></table></div>';
            } else {
                // CARDS (Mobile)
                html += '<div class="mobile-cards-container">';

                if (solicitacoes.length === 0) {
                    html += '<p style="text-align: center; padding: 20px; color: #999;">Nenhuma solicitação encontrada</p>';
                } else {
                    solicitacoes.forEach(solicitacao => {
                        const dataSolicitacao = new Date(solicitacao.data_solicitacao).toLocaleString('pt-BR');
                        let statusBadge = `<span class="status-badge ${solicitacao.status}">${solicitacao.status}</span>`;
                        const nomeUsuario = solicitacao.nome_usuario || '<em>Usuário não encontrado</em>';
                        const cpf = solicitacao.CPF || '<em>N/A</em>';

                        html += `<div class="mobile-card">
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">ID</span>
                                <span class="mobile-card-value">#${solicitacao.id}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">Email</span>
                                <span class="mobile-card-value"><strong>${solicitacao.email}</strong></span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">Nome</span>
                                <span class="mobile-card-value">${nomeUsuario}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">CPF</span>
                                <span class="mobile-card-value">${cpf}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">Data</span>
                                <span class="mobile-card-value">${dataSolicitacao}</span>
                            </div>
                            <div class="mobile-card-row">
                                <span class="mobile-card-label">Status</span>
                                <span class="mobile-card-value">${statusBadge}</span>
                            </div>`;

                        // Botões de ação
                        html += `<div class="mobile-card-actions">`;

                        if (solicitacao.status === 'pendente') {
                            const nomeEsc = (solicitacao.nome_usuario || '').replace(/'/g, "\\'");
                            const emailEsc = (solicitacao.email || '').replace(/'/g, "\\'");
                            const cpfEsc = (solicitacao.CPF || '').replace(/'/g, "\\'");
                            html += `<button class="btn-small btn-edit" onclick="modalRedefinirSenha(${solicitacao.id}, '${cpfEsc}', '${emailEsc}', '${nomeEsc}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg> Redefinir</button>`;
                        }

                        if (solicitacao.status === 'pendente') {
                            html += `<button class="btn-small btn-delete" onclick="cancelarSolicitacaoSenha(${solicitacao.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Cancelar</button>`;
                        }

                        if (solicitacao.status === 'resolvida' && solicitacao.observacoes) {
                            html += `<button class="btn-small btn-toggle" onclick="verObservacoesPorId(${solicitacao.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Ver Obs</button>`;
                        }

                        html += `</div></div>`;
                    });
                }

                html += '</div>';
            }

            html += `<div class="search-results-info">Mostrando ${solicitacoes.length} solicitações</div>`;
            document.getElementById('senhasContainer').innerHTML = html;

            // Re-render quando mudar entre mobile/desktop (debounce simples via flag)
            window.__lastSenhasIsMobile = isMobile;
            if (!window.__senhasResizeAttached) {
                window.__senhasResizeAttached = true;
                window.addEventListener('resize', () => {
                    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (nowMobile !== window.__lastSenhasIsMobile) {
                        window.__lastSenhasIsMobile = nowMobile;
                        if (currentData && currentData.senhas) {
                            renderizarSolicitacoesSenha(currentData.senhas, currentData.senhasMeta || {});
                        }
                    }
                });
            }
        }

        function modalRedefinirSenha(id, cpf, email, nome) {
            const novaSenha = prompt(
                `REDEFINIR SENHA\n\n` +
                `Usuário: ${nome}\n` +
                `Email: ${email}\n` +
                `CPF: ${cpf}\n\n` +
                `Digite a NOVA SENHA para este usuário:`
            );

            if (!novaSenha) return;

            if (novaSenha.length < 6) {
                alert('A senha deve ter no mínimo 6 caracteres!');
                return;
            }

            const observacoes = prompt(
                `OBSERVAÇÕES (opcional)\n\n` +
                `Adicione alguma observação sobre esta redefinição:\n` +
                `(deixe vazio se não quiser adicionar)`
            ) || `Senha redefinida pelo admin em ${new Date().toLocaleString('pt-BR')}`;

            if (confirm(`CONFIRMAR REDEFINIÇÃO\n\nUsuário: ${nome}\nEmail: ${email}\nNova Senha: ${'*'.repeat(novaSenha.length)}\n\nDeseja continuar?`)) {
                resolverSolicitacaoSenha(id, cpf, novaSenha, observacoes);
            }
        }

        async function resolverSolicitacaoSenha(id, cpf, novaSenha, observacoes) {
            try {
                await apiCall('senhas', 'POST', {
                    id: id,
                    cpf: cpf,
                    nova_senha: novaSenha,
                    observacoes: observacoes
                });

                alert('Senha redefinida com sucesso!\n\nO usuário já pode fazer login com a nova senha.');
                carregarSolicitacoesSenha();
            } catch (error) {
                console.error('Erro ao resolver solicitação:', error);
                alert('Erro ao redefinir senha. Verifique o console.');
            }
        }

        async function cancelarSolicitacaoSenha(id) {
            if (confirm('Tem certeza que deseja cancelar esta solicitação?\n\nEsta ação não pode ser desfeita.')) {
                try {
                    await apiCall(`senhas&id=${id}`, 'DELETE');
                    alert('Solicitação cancelada com sucesso!');
                    carregarSolicitacoesSenha();
                } catch (error) {
                    console.error('Erro ao cancelar solicitação:', error);
                }
            }
        }

        function verObservacoes(obs) {
            alert('OBSERVAÇÕES\n\n' + (obs || 'Sem observações.'));
        }

        function verObservacoesPorId(id) {
            try {
                const s = (currentData && currentData.senhas) ? currentData.senhas.find(x => x.id == id) : null;
                const obs = s && s.observacoes ? String(s.observacoes) : 'Sem observações.';
                alert('OBSERVAÇÕES\n\n' + obs);
            } catch (e) {
                alert('Não foi possível exibir as observações.');
                console.error('verObservacoesPorId error:', e);
            }
        }

        // =======================================
        // FUNCIONALIDADES DE BUSCA
        // =======================================

        // Variáveis para controle de timeout de busca
        let timeoutBuscaUsuarios = null;
        let timeoutBuscaCodigos = null;

        // Função para buscar usuários
        function buscarUsuarios() {
            // Limpa timeout anterior
            if (timeoutBuscaUsuarios) {
                clearTimeout(timeoutBuscaUsuarios);
            }

            // Define novo timeout para evitar muitas requisições
            timeoutBuscaUsuarios = setTimeout(() => {
                const termo = document.getElementById('searchUsuarios').value.trim().toLowerCase();

                if (!currentData.usuarios) {
                    console.log('Dados de usuários não carregados');
                    return;
                }

                let usuariosFiltrados = currentData.usuarios;

                if (termo) {
                    usuariosFiltrados = currentData.usuarios.filter(usuario => {
                        return (
                            usuario.Nome.toLowerCase().includes(termo) ||
                            usuario.CPF.includes(termo) ||
                            usuario.Email.toLowerCase().includes(termo) ||
                            (usuario.RA && usuario.RA.includes(termo))
                        );
                    });
                }

                renderizarUsuarios(usuariosFiltrados);
            }, 300); // 300ms de delay
        }

        // Função para buscar códigos
        function buscarCodigos() {
            // Limpa timeout anterior
            if (timeoutBuscaCodigos) {
                clearTimeout(timeoutBuscaCodigos);
            }

            // Define novo timeout para evitar muitas requisições
            timeoutBuscaCodigos = setTimeout(() => {
                const termo = document.getElementById('searchCodigos').value.trim().toUpperCase();

                if (!currentData.codigos) {
                    console.log('Dados de códigos não carregados');
                    return;
                }

                let codigosFiltrados = currentData.codigos;

                if (termo) {
                    codigosFiltrados = currentData.codigos.filter(codigo => {
                        return (
                            codigo.codigo.includes(termo) ||
                            (codigo.observacoes && codigo.observacoes.toLowerCase().includes(termo.toLowerCase())) ||
                            (codigo.usado_por && codigo.usado_por.toLowerCase().includes(termo.toLowerCase())) ||
                            codigo.id.toString() === termo
                        );
                    });
                }

                renderizarCodigos(codigosFiltrados);
            }, 300); // 300ms de delay
        }

        // Função para renderizar usuários filtrados
        function renderizarUsuarios(usuarios) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            let html = '';

            if (!isMobile) {
                html += '<div class="table-wrapper"><table class="admin-table">';
                html += '<thead><tr><th>CPF</th><th>Nome</th><th>Email</th><th>RA</th><th>Organizador</th><th>Código</th><th>Ações</th></tr></thead><tbody>';

                if (usuarios.length === 0) {
                    html += '<tr><td colspan="7" class="no-results">Nenhum usuário encontrado com os critérios de busca</td></tr>';
                } else {
                    usuarios.forEach(usuario => {
                        const organizador = usuario.Organizador ? 'Sim' : 'Não';
                        const statusClass = usuario.Organizador ? 'status-ativo' : 'status-inativo';
                        html += `<tr>
                            <td>${usuario.CPF}</td>
                            <td><strong>${usuario.Nome}</strong></td>
                            <td>${usuario.Email}</td>
                            <td>${usuario.RA || '-'}</td>
                            <td><span class="status-badge ${statusClass}">${organizador}</span></td>
                            <td>${usuario.Codigo || '-'}</td>
                            <td>
                                <button class="btn-small btn-toggle" onclick="toggleOrganizador('${usuario.CPF}', ${!usuario.Organizador})">
                                    ${usuario.Organizador ? '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg> Remover Org' : '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg> Tornar Org'}
                                </button>
                                <button class="btn-small btn-delete" onclick="excluirUsuario('${usuario.CPF}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Excluir</button>
                            </td>
                        </tr>`;
                    });
                }

                html += '</tbody></table></div>';
            } else {
                html += '<div class="mobile-cards-container">';

                if (usuarios.length === 0) {
                    html += '<p class="no-results">Nenhum usuário encontrado com os critérios de busca</p>';
                } else {
                    usuarios.forEach(usuario => {
                        const organizador = usuario.Organizador ? 'Sim' : 'Não';
                        const statusClass = usuario.Organizador ? 'status-ativo' : 'status-inativo';
                        html += `<div class="mobile-card">
                            <div class="mobile-card-row"><span class="mobile-card-label">CPF</span><span class="mobile-card-value">${usuario.CPF}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Nome</span><span class="mobile-card-value"><strong>${usuario.Nome}</strong></span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Email</span><span class="mobile-card-value">${usuario.Email}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">RA</span><span class="mobile-card-value">${usuario.RA || '-'}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Organizador</span><span class="mobile-card-value"><span class="status-badge ${statusClass}">${organizador}</span></span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Código</span><span class="mobile-card-value">${usuario.Codigo || '-'}</span></div>
                            <div class="mobile-card-actions">
                                <button class="btn-small btn-toggle" onclick="toggleOrganizador('${usuario.CPF}', ${!usuario.Organizador})">${usuario.Organizador ? 'Remover Org' : 'Tornar Org'}</button>
                                <button class="btn-small btn-delete" onclick="excluirUsuario('${usuario.CPF}')">Excluir</button>
                            </div>
                        </div>`;
                    });
                }

                html += '</div>';
            }

            html += `<div class="search-results-info">Mostrando ${usuarios.length} de ${currentData.usuarios.length} usuários</div>`;
            document.getElementById('usuariosContainer').innerHTML = html;

            window.__lastUsuariosIsMobile = isMobile;
            if (!window.__usuariosResizeAttached) {
                window.__usuariosResizeAttached = true;
                window.addEventListener('resize', () => {
                    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (nowMobile !== window.__lastUsuariosIsMobile && currentData.usuarios) {
                        window.__lastUsuariosIsMobile = nowMobile;
                        renderizarUsuarios(currentData.usuarios);
                    }
                });
            }
        }

        // Função para renderizar códigos filtrados
        function renderizarCodigos(codigos) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            let html = '';

            if (!isMobile) {
                html += '<div class="table-wrapper"><table class="admin-table">';
                html += '<thead><tr><th>ID</th><th>Código</th><th>Status</th><th>Usado</th><th>Data Criação</th><th>Usado Por</th><th>Observações</th><th>Ações</th></tr></thead><tbody>';

                if (codigos.length === 0) {
                    html += '<tr><td colspan="8" class="no-results">Nenhum código encontrado com os critérios de busca</td></tr>';
                } else {
                    codigos.forEach(codigo => {
                        const ativo = codigo.ativo == 1 ? 'Ativo' : 'Inativo';
                        const usado = codigo.usado == 1 ? 'Sim' : 'Não';
                        const statusClass = codigo.ativo == 1 ? (codigo.usado == 1 ? 'status-usado' : 'status-ativo') : 'status-inativo';
                        const dataCriacao = new Date(codigo.data_criacao).toLocaleDateString('pt-BR');

                        html += `<tr>
                            <td>${codigo.id}</td>
                            <td><strong>${codigo.codigo}</strong></td>
                            <td><span class="status-badge ${statusClass}">${ativo}</span></td>
                            <td>${usado}</td>
                            <td>${dataCriacao}</td>
                            <td>${codigo.usado_por || '-'}</td>
                            <td>${codigo.observacoes || '-'}</td>
                            <td>
                                <button class="btn-small btn-toggle" onclick="toggleCodigo(${codigo.id}, ${codigo.ativo == 1 ? 0 : 1})">
                                    ${codigo.ativo == 1 ? '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg> Desativar' : '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/></svg> Ativar'}
                                </button>
                                <button class="btn-small btn-delete" onclick="excluirCodigo(${codigo.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Excluir</button>
                            </td>
                        </tr>`;
                    });
                }

                html += '</tbody></table></div>';
            } else {
                html += '<div class="mobile-cards-container">';

                if (codigos.length === 0) {
                    html += '<p class="no-results">Nenhum código encontrado com os critérios de busca</p>';
                } else {
                    codigos.forEach(codigo => {
                        const ativo = codigo.ativo == 1 ? 'Ativo' : 'Inativo';
                        const usado = codigo.usado == 1 ? 'Sim' : 'Não';
                        const statusClass = codigo.ativo == 1 ? (codigo.usado == 1 ? 'status-usado' : 'status-ativo') : 'status-inativo';
                        const dataCriacao = new Date(codigo.data_criacao).toLocaleDateString('pt-BR');
                        html += `<div class="mobile-card">
                            <div class="mobile-card-row"><span class="mobile-card-label">ID</span><span class="mobile-card-value">#${codigo.id}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Código</span><span class="mobile-card-value"><strong>${codigo.codigo}</strong></span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Status</span><span class="mobile-card-value"><span class="status-badge ${statusClass}">${ativo}</span></span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Usado</span><span class="mobile-card-value">${usado}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Criado em</span><span class="mobile-card-value">${dataCriacao}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Usado por</span><span class="mobile-card-value">${codigo.usado_por || '-'}</span></div>
                            <div class="mobile-card-row"><span class="mobile-card-label">Observações</span><span class="mobile-card-value">${codigo.observacoes || '-'}</span></div>
                            <div class="mobile-card-actions">
                                <button class="btn-small btn-toggle" onclick="toggleCodigo(${codigo.id}, ${codigo.ativo == 1 ? 0 : 1})">${codigo.ativo == 1 ? 'Desativar' : 'Ativar'}</button>
                                <button class="btn-small btn-delete" onclick="excluirCodigo(${codigo.id})">Excluir</button>
                            </div>
                        </div>`;
                    });
                }

                html += '</div>';
            }

            html += `<div class="search-results-info">Mostrando ${codigos.length} de ${currentData.codigos.length} códigos</div>`;
            document.getElementById('codigosContainer').innerHTML = html;

            window.__lastCodigosIsMobile = isMobile;
            if (!window.__codigosResizeAttached) {
                window.__codigosResizeAttached = true;
                window.addEventListener('resize', () => {
                    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (nowMobile !== window.__lastCodigosIsMobile && currentData.codigos) {
                        window.__lastCodigosIsMobile = nowMobile;
                        renderizarCodigos(currentData.codigos);
                    }
                });
            }
        }

        // Funções para limpar buscas
        function limparBuscaUsuarios() {
            document.getElementById('searchUsuarios').value = '';
            if (currentData.usuarios) {
                renderizarUsuarios(currentData.usuarios);
            }
        }

        function limparBuscaCodigos() {
            document.getElementById('searchCodigos').value = '';
            if (currentData.codigos) {
                renderizarCodigos(currentData.codigos);
            }
        }

        function logout() {
            if (confirm('Deseja sair do sistema?')) {
                localStorage.removeItem('admin_temp_auth');
                window.location.href = 'LoginAdmin.html';
            }
        }

        // =======================================
        // BACKUPS
        // =======================================

        async function carregarInfoBackups() {
            try {
                const response = await fetch('GerenciadorBackup.php?acao=info');
                const data = await response.json();

                if (data.sucesso) {
                    document.getElementById('infoBDTamanho').textContent = data.tamanho;
                }
            } catch (e) {
                console.error('Erro ao carregar info:', e);
            }
        }

        async function carregarBackups() {
            const btn = event.target;
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Processando...';

            try {
                const response = await fetch('GerenciadorBackup.php?acao=fazer-backup', { method: 'POST' });
                const data = await response.json();

                if (data.sucesso) {
                    alert('✅ Backup realizado com sucesso!');
                    await carregarListaBackups();
                    await carregarInfoBackups();
                } else {
                    alert('❌ Erro: ' + data.mensagem);
                }
            } catch (e) {
                alert('Erro ao fazer backup: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function carregarListaBackups() {
            try {
                const response = await fetch('GerenciadorBackup.php?acao=listar', { method: 'POST' });
                const data = await response.json();

                if (data.sucesso) {
                    document.getElementById('infoBDTotal').textContent = data.total;
                    currentData.backups = data.backups || [];
                    renderizarBackups(currentData.backups, data.total);
                } else {
                    document.getElementById('backupsContainer').innerHTML = '<p style="color: red;">Erro ao carregar backups</p>';
                }
            } catch (e) {
                document.getElementById('backupsContainer').innerHTML = '<p style="color: red;">Erro: ' + e.message + '</p>';
            }
        }

        function renderizarBackups(backups, total) {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            let html = '';

            if (!isMobile) {
                html += '<div class="table-wrapper"><table class="admin-table">';
                html += '<thead><tr><th>Data/Hora</th><th>Tamanho</th><th>Ações</th></tr></thead><tbody>';
                if (!backups || backups.length === 0) {
                    html += '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">📁 Nenhum backup disponível</td></tr>';
                } else {
                    backups.forEach(backup => {
                        html += '<tr>' +
                            '<td>' + backup.data + '</td>' +
                            '<td>' + backup.tamanhoFormatado + '</td>' +
                            '<td>' +
                            '<button class="btn-small btn-download" onclick="baixarBackup(\'' + backup.nome + '\')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Baixar</button> ' +
                            '<button class="btn-small btn-restore" onclick="restaurarBackupConfirm(\'' + backup.nome + '\')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg> Restaurar</button> ' +
                            '<button class="btn-small btn-delete" onclick="deletarBackupConfirm(\'' + backup.nome + '\')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Deletar</button>' +
                            '</td>' +
                            '</tr>';
                    });
                }
                html += '</tbody></table></div>';
            } else {
                html += '<div class="mobile-cards-container">';
                if (!backups || backups.length === 0) {
                    html += '<p style="text-align:center; padding:20px; color:#999;">📁 Nenhum backup disponível</p>';
                } else {
                    backups.forEach(backup => {
                        html += '<div class="mobile-card">' +
                            '<div class="mobile-card-row"><span class="mobile-card-label">Data/Hora</span><span class="mobile-card-value">' + backup.data + '</span></div>' +
                            '<div class="mobile-card-row"><span class="mobile-card-label">Tamanho</span><span class="mobile-card-value">' + backup.tamanhoFormatado + '</span></div>' +
                            '<div class="mobile-card-actions">' +
                            '<button class="btn-small btn-download" onclick="baixarBackup(\'' + backup.nome + '\')">Baixar</button>' +
                            '<button class="btn-small btn-restore" onclick="restaurarBackupConfirm(\'' + backup.nome + '\')">Restaurar</button>' +
                            '<button class="btn-small btn-delete" onclick="deletarBackupConfirm(\'' + backup.nome + '\')">Deletar</button>' +
                            '</div>' +
                            '</div>';
                    });
                }
                html += '</div>';
            }

            html += '<div class="search-results-info">Mostrando ' + (backups ? backups.length : 0) + ' de ' + (typeof total === 'number' ? total : (backups ? backups.length : 0)) + ' backups</div>';
            document.getElementById('backupsContainer').innerHTML = html;

            window.__lastBackupsIsMobile = isMobile;
            if (!window.__backupsResizeAttached) {
                window.__backupsResizeAttached = true;
                window.addEventListener('resize', () => {
                    const nowMobile = window.matchMedia('(max-width: 768px)').matches;
                    if (nowMobile !== window.__lastBackupsIsMobile && currentData.backups) {
                        window.__lastBackupsIsMobile = nowMobile;
                        renderizarBackups(currentData.backups, document.getElementById('infoBDTotal')?.textContent || backups.length);
                    }
                });
            }
        }

        function baixarBackup(nome) {
            window.location.href = 'GerenciadorBackup.php?acao=baixar&arquivo=' + encodeURIComponent(nome);
        }

        function restaurarBackupConfirm(nome) {
            if (!confirm('ATENÇÃO: Tem certeza? Isto vai RESTAURAR o banco de dados e SUBSTITUIR todos os dados atuais!')) {
                return;
            }
            restaurarBackup(nome);
        }

        async function restaurarBackup(nome) {
            try {
                const formData = new FormData();
                formData.append('arquivo', nome);

                const response = await fetch('GerenciadorBackup.php?acao=restaurar', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.sucesso) {
                    alert('✅ Backup restaurado com sucesso!');
                    location.reload();
                } else {
                    alert('❌ Erro: ' + data.mensagem);
                }
            } catch (e) {
                alert('Erro ao restaurar: ' + e.message);
            }
        }

        function deletarBackupConfirm(nome) {
            if (!confirm('Tem certeza que deseja deletar este backup?')) {
                return;
            }
            deletarBackup(nome);
        }

        async function deletarBackup(nome) {
            try {
                const formData = new FormData();
                formData.append('arquivo', nome);

                const response = await fetch('GerenciadorBackup.php?acao=deletar', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.sucesso) {
                    alert('✅ Backup deletado com sucesso!');
                    await carregarListaBackups();
                } else {
                    alert('❌ Erro: ' + data.mensagem);
                }
            } catch (e) {
                alert('Erro ao deletar: ' + e.message);
            }
        }

        // =======================================
        // PWA / REDE - DIAGNÓSTICO E AÇÕES
        // =======================================
        async function carregarPwaRede() {
            // Reset UI
            document.getElementById('pwaLocalUrl').textContent = '-';
            document.getElementById('pwaSwStatus').textContent = 'checando...';
            document.getElementById('pwaSwScope').textContent = 'escopo: -';
            document.getElementById('pwaManifestStatus').textContent = 'checando...';
            document.getElementById('pwaManifestHref').textContent = 'manifest: -';
            document.getElementById('pwaDetalhes').textContent = 'Coletando informações...';

            const detalhes = [];
            try {
                const result = await apiCall('pwa');
                const info = result.data || {};
                const basePath = info.base_path || '/CEU';
                const hostPref = info.server_addr && !['127.0.0.1', '::1', 'localhost'].includes(String(info.server_addr).toLowerCase())
                    ? info.server_addr
                    : (info.http_host || location.host);
                const localUrl = 'http://' + hostPref + basePath + '/';
                document.getElementById('pwaLocalUrl').textContent = localUrl;
                detalhes.push('Servidor: ' + (info.server_name || '-') + ' | IP: ' + (info.server_addr || '-') + ' | Host: ' + (info.http_host || '-'));
                detalhes.push('Base: ' + basePath + ' | DOC_ROOT: ' + (info.document_root || '-'));
                detalhes.push('Arquivos PWA: sw=' + (info.paths?.sw_exists ? 'ok' : 'faltando') + ', manifest=' + (info.paths?.manifest_exists ? 'ok' : 'faltando') + ', manifest-install=' + (info.paths?.manifest_install_exists ? 'ok' : 'faltando'));

                // Service Worker
                let regs = [];
                try {
                    regs = await (navigator.serviceWorker?.getRegistrations?.() || Promise.resolve([]));
                } catch (e) { /* ignore */ }
                if (regs && regs.length) {
                    const active = navigator.serviceWorker.controller ? 'controlando esta página' : 'registrado (sem controlar)';
                    document.getElementById('pwaSwStatus').textContent = 'registrado (' + regs.length + '), ' + active;
                    const r0 = regs[0];
                    document.getElementById('pwaSwScope').textContent = 'escopo: ' + (r0.scope || '-');
                    detalhes.push('SW: ' + (r0.active?.scriptURL || r0.installing?.scriptURL || r0.waiting?.scriptURL || '-') + ' | scope=' + (r0.scope || '-'));
                } else {
                    document.getElementById('pwaSwStatus').textContent = 'não registrado';
                    document.getElementById('pwaSwScope').textContent = 'escopo: -';
                    detalhes.push('SW: não registrado');
                }

                // Manifestos
                let manifestHref = (document.querySelector('link[rel="manifest"]')?.href) || '';
                if (manifestHref) {
                    document.getElementById('pwaManifestHref').textContent = 'manifest: ' + manifestHref;
                } else {
                    document.getElementById('pwaManifestHref').textContent = 'manifest: (nenhum <link> na página Admin)';
                }

                const iconsCount = async (url) => {
                    try {
                        const res = await fetch(url, { cache: 'no-store' });
                        if (!res.ok) return 0;
                        const json = await res.json();
                        return Array.isArray(json.icons) ? json.icons.length : 0;
                    } catch { return 0; }
                };

                const defIcons = await iconsCount(info.paths?.manifest_url || (basePath + '/manifest.json'));
                const instIcons = await iconsCount(info.paths?.manifest_install_url || (basePath + '/manifest-install.json'));
                const statusTxt = `Padrão: ${defIcons > 0 ? 'instalável' : 'não instalável'} | manifest-install: ${instIcons > 0 ? 'instalável' : 'não instalável'}`;
                document.getElementById('pwaManifestStatus').textContent = statusTxt;
                detalhes.push('Manifest: icons padrão=' + defIcons + ', icons install=' + instIcons);

                // Caches
                try {
                    const keys = await (caches?.keys?.() || Promise.resolve([]));
                    detalhes.push('Caches: ' + (keys.length ? keys.join(', ') : '(nenhum)'));
                } catch (e) {
                    detalhes.push('Caches: indisponível (' + e.message + ')');
                }

            } catch (e) {
                detalhes.push('Erro ao carregar info de PWA/rede: ' + e.message);
            }

            document.getElementById('pwaDetalhes').textContent = detalhes.join('\n');
        }

        async function limparCaches() {
            try {
                const keys = await caches.keys();
                await Promise.all(keys.map(k => caches.delete(k)));
                alert('Caches limpos com sucesso.');
            } catch (e) {
                alert('Falha ao limpar caches: ' + e.message);
            } finally {
                carregarPwaRede();
            }
        }

        async function desregistrarServiceWorkers() {
            try {
                const regs = await (navigator.serviceWorker?.getRegistrations?.() || []);
                await Promise.all(regs.map(r => r.unregister()));
                alert('Service Workers desregistrados. Recarregue páginas do app para registrar novamente.');
            } catch (e) {
                alert('Falha ao desregistrar SW: ' + e.message);
            } finally {
                carregarPwaRede();
            }
        }

        function verificarManifestos() {
            carregarPwaRede();
        }
    </script>
    <script>
        // Dropdown custom global para todos os <select> da área admin (mobile e desktop)
        const AdminDDL = (() => {
            const registry = new Map(); // selectEl -> teardown()

            function buildForSelect(select) {
                if (!select || select.dataset.ddlInitialized === '1') return;
                // Evitar selects múltiplos
                if (select.multiple) return;

                const wrapper = select.parentElement || select.closest('.select-wrapper') || select.parentNode;
                if (!wrapper) return;

                // Esconde o select nativo
                select.classList.add('ddl-hidden-native');
                select.dataset.ddlInitialized = '1';

                // Container
                const container = document.createElement('div');
                container.className = 'ddl-container';

                // Botão toggle
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'ddl-toggle';
                btn.setAttribute('aria-haspopup', 'listbox');
                btn.setAttribute('aria-expanded', 'false');
                if (select.disabled) btn.disabled = true;

                const labelSpan = document.createElement('span');
                labelSpan.className = 'ddl-label';
                labelSpan.textContent = (select.selectedOptions[0]?.text) || (select.options[0]?.text) || 'Selecionar';

                const arrow = document.createElement('span');
                arrow.className = 'ddl-arrow';
                arrow.textContent = '▼';

                btn.appendChild(labelSpan);
                btn.appendChild(arrow);

                // Menu
                const menu = document.createElement('div');
                menu.className = 'ddl-menu';
                menu.setAttribute('role', 'listbox');
                menu.setAttribute('tabindex', '-1');

                Array.from(select.options).forEach((opt) => {
                    const item = document.createElement('div');
                    item.className = 'ddl-item';
                    item.setAttribute('role', 'option');
                    item.dataset.value = opt.value;
                    item.textContent = opt.text;
                    if (opt.disabled) item.setAttribute('aria-disabled', 'true');
                    if (opt.selected) item.classList.add('selected');

                    item.addEventListener('click', () => {
                        if (opt.disabled) return;
                        select.value = opt.value;
                        labelSpan.textContent = opt.text;
                        // Atualiza seleção visual
                        menu.querySelectorAll('.ddl-item').forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        // Dispara change
                        select.dispatchEvent(new Event('change', { bubbles: true }));
                        close();
                    });

                    menu.appendChild(item);
                });

                container.appendChild(btn);
                container.appendChild(menu);
                wrapper.appendChild(container);

                // Ações abrir/fechar
                function open() {
                    if (btn.disabled) return;
                    container.classList.add('open');
                    btn.setAttribute('aria-expanded', 'true');
                    menu.focus();
                }
                function close() {
                    container.classList.remove('open');
                    btn.setAttribute('aria-expanded', 'false');
                }

                btn.addEventListener('click', () => {
                    if (container.classList.contains('open')) close(); else open();
                });
                btn.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); }
                });

                function onDocClick(e) {
                    if (!container.contains(e.target)) close();
                }
                document.addEventListener('click', onDocClick);

                function onKeyDown(e) {
                    const items = Array.from(menu.querySelectorAll('.ddl-item'));
                    let idx = items.findIndex(i => i.classList.contains('selected'));

                    if (e.key === 'Escape') {
                        e.preventDefault();
                        close();
                        btn.focus();
                        return;
                    }
                    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (idx < 0) idx = 0;
                        idx = e.key === 'ArrowDown' ? Math.min(items.length - 1, idx + 1) : Math.max(0, idx - 1);
                        items.forEach(i => i.classList.remove('selected'));
                        const next = items[idx];
                        next.classList.add('selected');
                        next.scrollIntoView({ block: 'nearest' });
                        return;
                    }
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        const chosen = items.find(i => i.classList.contains('selected')) || items[0];
                        if (chosen) chosen.click();
                    }
                }
                menu.addEventListener('keydown', onKeyDown);

                // Sincroniza se o select mudar por script
                function onNativeChange() {
                    const opt = select.options[select.selectedIndex];
                    if (opt) labelSpan.textContent = opt.text;
                    menu.querySelectorAll('.ddl-item').forEach(i => {
                        i.classList.toggle('selected', i.dataset.value === select.value);
                    });
                }
                select.addEventListener('change', onNativeChange);

                const teardown = () => {
                    document.removeEventListener('click', onDocClick);
                    menu.removeEventListener('keydown', onKeyDown);
                    select.removeEventListener('change', onNativeChange);
                    container.remove();
                    select.classList.remove('ddl-hidden-native');
                    delete select.dataset.ddlInitialized;
                };
                registry.set(select, teardown);
            }

            function ensureAll(root = document) {
                const scope = root.querySelector('.admin-page-container') || root;
                const selects = scope.querySelectorAll('select');
                selects.forEach(buildForSelect);
            }

            // Rebuild simples quando conteúdos dinâmicos são injetados
            let mo;
            function attachObserver() {
                const container = document.querySelector('.admin-page-container');
                if (!container) return;
                if (mo) return;
                mo = new MutationObserver((mutations) => {
                    let needsEnsure = false;
                    for (const m of mutations) {
                        if (m.addedNodes && m.addedNodes.length) { needsEnsure = true; break; }
                    }
                    if (needsEnsure) ensureAll(container);
                });
                mo.observe(container, { childList: true, subtree: true });
            }

            function init() {
                ensureAll();
                attachObserver();
            }

            return { init, ensureAll };
        })();

        document.addEventListener('DOMContentLoaded', AdminDDL.init);
    </script>
</body>

</html>
