<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - CEU</title>
    <link rel="stylesheet" href="../styleGlobal.css">
    <link rel="stylesheet" href="styleAdmin.css">
    <style>
        .visually-hidden {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div class="admin-page-container">
        <div id="loadingScreen"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--fundo); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div style="text-align: center; color: var(--branco);">
                <div
                    style="width: 50px; height: 50px; border: 3px solid var(--caixas); border-top: 3px solid var(--botao); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;">
                </div>
                <p>Carregando painel administrativo...</p>
            </div>
        </div>

        <div id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h1><svg class="icon icon-medium" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" />
                    </svg> Painel Administrativo - CEU</h1>
                <p class="subtitle">Sistema de Gerenciamento Completo</p>
            </div>

            <div class="admin-container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">

                <!-- Navegação -->
                <div class="admin-nav"
                    style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; padding: 10px 0;">
                    <button id="btnDashboard" class="btn-secondary active" onclick="showSection('dashboard')"><svg
                            class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                        </svg> Dashboard</button>
                    <button id="btnEventos" class="btn-secondary" onclick="showSection('eventos')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z" />
                        </svg> Eventos</button>
                    <button id="btnUsuarios" class="btn-secondary" onclick="showSection('usuarios')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg> Usuários</button>
                    <button id="btnCodigos" class="btn-secondary" onclick="showSection('codigos')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
                        </svg> Códigos</button>
                    <button id="btnCertificados" class="btn-secondary" onclick="showSection('certificados')"><svg
                            class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4zm16-8V4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" />
                        </svg> Certificados</button>
                    <button id="btnSenhas" class="btn-secondary" onclick="showSection('senhas')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                        </svg> Senhas</button>
                    <button id="btnBackups" class="btn-secondary" onclick="showSection('backups')"><svg class="icon"
                            viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                        </svg> Backups</button>
                    <button id="btnSair" class="btn-secondary" onclick="logout()"
                        style="margin-left: auto; background: var(--vermelho);"><svg class="icon" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
                        </svg> Sair</button>
                </div>

                <!-- Dashboard -->
                <div id="dashboard" class="admin-section active">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                        </svg> Dashboard do Sistema</h3>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="stats-card" style="border-left-color: #28a745;">
                            <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z" />
                                </svg> Total de Eventos</h4>
                            <p id="totalEventos">-</p>
                            <small>Eventos cadastrados no sistema</small>
                        </div>
                        <div class="stats-card" style="border-left-color: var(--botao);">
                            <h4 style="color: var(--botao);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                                </svg> Total de Usuários</h4>
                            <p id="totalUsuarios">-</p>
                            <small>Usuários registrados</small>
                        </div>
                        <div class="stats-card" style="border-left-color: #ffc107;">
                            <h4 style="color: #ffc107;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                                </svg> Organizadores</h4>
                            <p id="totalOrganizadores">-</p>
                            <small>Usuários com perfil organizador</small>
                        </div>
                        <div class="stats-card" style="border-left-color: var(--vermelho);">
                            <h4 style="color: var(--vermelho);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
                                </svg> Códigos Ativos</h4>
                            <p id="totalCodigos">-</p>
                            <small>Códigos de organizador disponíveis</small>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                fill="currentColor">
                                <path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z" />
                            </svg> Estatísticas Recentes</h4>
                        <div id="estatisticas">Carregando estatísticas...</div>
                    </div>
                </div>

                <!-- Gerenciamento de Eventos -->
                <div id="eventos" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z" />
                        </svg> Gerenciamento de Eventos</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="showModalEvento()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg> Novo Evento</button>
                        <button class="btn-secondary" onclick="carregarEventos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="exportarEventos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" />
                            </svg> Exportar</button>
                    </div>

                    <div class="admin-container" id="eventosContainer">
                        <p>Carregando eventos...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Usuários -->
                <div id="usuarios" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M16 11c1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z" />
                        </svg> Gerenciamento de Usuários</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="showModalUsuario()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg> Novo Usuário</button>
                        <button class="btn-secondary" onclick="carregarUsuarios()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="exportarUsuarios()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z" />
                            </svg> Exportar</button>
                        <label for="searchUsuarios" class="visually-hidden">Buscar usuários</label>
                        <input type="text" id="searchUsuarios" name="searchUsuarios"
                            placeholder="Buscar por nome, CPF ou email..." class="search-input" style="width: 350px;"
                            oninput="buscarUsuarios()" autocomplete="off">
                        <button class="clear-search" onclick="limparBuscaUsuarios()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg> Limpar</button>
                    </div>

                    <div class="admin-container" id="usuariosContainer">
                        <p>Carregando usuários...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Códigos -->
                <div id="codigos" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
                        </svg> Gerenciamento de Códigos</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="gerarNovoCodigo()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                            </svg> Gerar Código</button>
                        <button class="btn-secondary" onclick="carregarCodigos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="gerarCodigosLote()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                            </svg> Gerar em Lote</button>
                        <label for="searchCodigos" class="visually-hidden">Buscar códigos</label>
                        <input type="text" id="searchCodigos" name="searchCodigos" placeholder="Buscar código..."
                            class="search-input" style="width: 250px;" oninput="buscarCodigos()" autocomplete="off">
                        <button class="clear-search" onclick="limparBuscaCodigos()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                            </svg> Limpar</button>
                    </div>

                    <div class="admin-container" id="codigosContainer">
                        <p>Carregando códigos...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Certificados -->
                <div id="certificados" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4zm16-8V4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z" />
                        </svg> Gerenciamento de Certificados</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="carregarCertificados()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <button class="btn-secondary" onclick="validarCertificados()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                            </svg> Validar Todos</button>
                    </div>

                    <div class="admin-container" id="certificadosContainer">
                        <p>Carregando certificados...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Solicitações de Senha -->
                <div id="senhas" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z" />
                        </svg> Gerenciamento de Redefinições de Senha</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="carregarSolicitacoesSenha()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar</button>
                        <label for="filtroStatusSenha" class="visually-hidden">Filtrar por status</label>
                        <select id="filtroStatusSenha" class="search-input" style="width: 180px;"
                            onchange="carregarSolicitacoesSenha()">
                            <option value="all">Todos</option>
                            <option value="pendente" selected>Pendentes</option>
                            <option value="resolvida">Resolvidas</option>
                            <option value="cancelada">Canceladas</option>
                        </select>
                    </div>

                    <div class="admin-container" id="senhasContainer">
                        <p>Carregando solicitações...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Backups -->
                <div id="backups" class="admin-section">
                    <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z" />
                        </svg> Gerenciamento de Backups</h3>

                    <div style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="carregarBackups()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                            </svg> Fazer Backup Agora</button>
                        <button class="btn-secondary" onclick="carregarListaBackups()"><svg class="icon icon-small"
                                viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                            </svg> Atualizar Lista</button>
                    </div>

                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="stats-card" style="border-left-color: var(--botao);">
                            <h4 style="color: var(--botao);"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z" />
                                </svg> Tamanho BD</h4>
                            <p id="infoBDTamanho">-</p>
                        </div>
                        <div class="stats-card" style="border-left-color: #28a745;">
                            <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z" />
                                </svg> Backups</h4>
                            <p id="infoBDTotal">0</p>
                        </div>
                    </div>

                    <div class="admin-container" id="backupsContainer">
                        <p>Carregando backups...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal para Eventos -->
    <div id="modalEvento"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div class="admin-container"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <h3 id="modalEventoTitle">Novo Evento</h3>
            <form id="formEvento">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div class="form-group">
                        <label for="cod_evento">Código do Evento:</label>
                        <input type="number" id="cod_evento" name="cod_evento" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria:</label>
                        <select id="categoria" name="categoria" required autocomplete="off">
                            <option value="">Selecione...</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Palestra">Palestra</option>
                            <option value="Curso">Curso</option>
                            <option value="Semana">Semana</option>
                            <option value="Minicurso">Minicurso</option>
                            <option value="Hackathon">Hackathon</option>
                            <option value="Conferência">Conferência</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="nome">Nome do Evento:</label>
                        <input type="text" id="nome" name="nome" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="lugar">Local:</label>
                        <input type="text" id="lugar" name="lugar" required autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="modalidade">Modalidade:</label>
                        <select id="modalidade" name="modalidade" required autocomplete="off">
                            <option value="Presencial">Presencial</option>
                            <option value="Online">Online</option>
                            <option value="Híbrido">Híbrido</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2;">
                        <label for="descricao">Descrição:</label>
                        <textarea id="descricao" name="descricao"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px;"
                            autocomplete="off"></textarea>
                    </div>
                    <div>
                        <label for="publico_alvo">Público Alvo:</label>
                        <input type="text" id="publico_alvo" name="publico_alvo"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div>
                        <label for="duracao">Duração (horas):</label>
                        <input type="number" step="0.5" id="duracao" name="duracao"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div>
                        <label for="inicio">Data/Hora Início:</label>
                        <input type="datetime-local" id="inicio" name="inicio" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div>
                        <label for="conclusao">Data/Hora Fim:</label>
                        <input type="datetime-local" id="conclusao" name="conclusao" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div style="grid-column: span 2;">
                        <label for="certificado">
                            <input type="checkbox" id="certificado" name="certificado" value="1"> Gera Certificado
                        </label>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn-generate">Salvar Evento</button>
                    <button type="button" class="btn-secondary" onclick="fecharModalEvento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Usuários -->
    <div id="modalUsuario"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div class="admin-container"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <h3 id="modalUsuarioTitle">Novo Usuário</h3>
            <form id="formUsuario">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="usuario_cpf">CPF: *</label>
                        <input type="text" id="usuario_cpf" name="cpf" required
                            placeholder="Apenas números (11 dígitos)" maxlength="11" pattern="[0-9]{11}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                        <small style="color: #ffffff;">Digite apenas números, sem pontos ou traços</small>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="usuario_nome">Nome Completo: *</label>
                        <input type="text" id="usuario_nome" name="nome" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label for="usuario_email">Email: *</label>
                        <input type="email" id="usuario_email" name="email" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="usuario_senha">Senha: *</label>
                        <input type="password" id="usuario_senha" name="senha" required minlength="6"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="new-password">
                        <small style="color: #ffffff;">Mínimo 6 caracteres</small>
                    </div>
                    <div class="form-group">
                        <label for="usuario_confirma_senha">Confirmar Senha: *</label>
                        <input type="password" id="usuario_confirma_senha" name="confirma_senha" required minlength="6"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="usuario_ra">RA: (opcional)</label>
                        <input type="text" id="usuario_ra" name="ra" placeholder="7 dígitos" maxlength="7"
                            pattern="[0-9]{7}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="usuario_organizador">Tipo de Usuário:</label>
                        <select id="usuario_organizador" name="organizador" onchange="toggleCodigoOrganizador()"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                            autocomplete="off">
                            <option value="0">Participante</option>
                            <option value="1">Organizador</option>
                        </select>
                    </div>
                    <div class="form-group" id="codigoOrganizadorField" style="grid-column: span 2; display: none;">
                        <label for="usuario_codigo">Código de Organizador: *</label>
                        <input type="text" id="usuario_codigo" name="codigo" placeholder="8 caracteres" maxlength="8"
                            pattern="[A-Z0-9]{8}"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-transform: uppercase;"
                            autocomplete="off">
                        <small style="color: #ffffff;">Código de 8 caracteres para organizador</small>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn-generate"><svg class="icon icon-small" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
                        </svg> Salvar Usuário</button>
                    <button type="button" class="btn-secondary" onclick="fecharModalUsuario()"><svg
                            class="icon icon-small" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z" />
                        </svg> Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gerenciamento de Códigos -->
    <div id="codes" class="admin-section">
        <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M21 5v14H3V5h18m0-2H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-11 5h10V6H10v2zm0 2v2h10v-2H10zm0 4v2h7v-2h-7zM5 7h2v2H5V7zm0 4h2v2H5v-2zm0 4h2v2H5v-2z" />
            </svg> Gerenciamento de Códigos</h3>

        <div style="margin-bottom: 20px;">
            <button class="btn-generate" onclick="gerarNovoCodigo()"><svg class="icon icon-small" viewBox="0 0 24 24"
                    fill="currentColor">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg> Gerar Novo Código</button>
            <button class="btn-secondary" onclick="carregarCodigos()"><svg class="icon icon-small" viewBox="0 0 24 24"
                    fill="currentColor">
                    <path
                        d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
                </svg> Atualizar Lista</button>
        </div>

        <div id="codigosList" style="background: white; border-radius: 10px; padding: 20px;">
            <p>Carregando códigos...</p>
        </div>
    </div>

    <!-- Área de Teste -->
    <div id="test" class="admin-section">
        <h3><svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M20 2H4c-1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z" />
            </svg> Área de Teste</h3>

        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h4>Teste de Funcionalidades</h4>

            <div style="margin: 15px 0;">
                <button class="btn-test" onclick="testarConexaoBD()"><svg class="icon icon-small" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-5 5-5-5h3V9h4v4h3z" />
                    </svg> Testar Banco de Dados</button>
                <button class="btn-test" onclick="testarSessao()"><svg class="icon icon-small" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" />
                    </svg> Testar Sessão</button>
                <button class="btn-test" onclick="testarLogs()"><svg class="icon icon-small" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path
                            d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                    </svg> Verificar Logs</button>
            </div>

            <div id="testResults"
                style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; min-height: 100px; margin-top: 15px;">
                Clique em um dos botões acima para executar testes.
            </div>
        </div>
    </div>

    </div>
    </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .admin-nav button.active {
            background: #28a745 !important;
            transform: scale(1.05);
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--botao);
        }

        .data-table th {
            background-color: var(--botao);
            font-weight: bold;
        }

        .data-table tr:hover {
            background-color: var(--botao);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-ativo {
            background: #d4edda;
            color: #155724;
        }

        .status-inativo {
            background: #f8d7da;
            color: #721c24;
        }

        .status-usado {
            background: #fff3cd;
            color: #856404;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin: 2px;
        }

        .btn-edit {
            background: #4F6C8C;
            color: white;
        }

        .btn-delete {
            background: var(--vermelho);
            color: white;
        }

        .btn-toggle {
            background: #4F6C8C;
        }

        .btn-download {
            background: #28a745;
            color: white;
        }

        .btn-download:hover {
            background: #28a745;
        }

        .btn-restore {
            background: #ffc107;
            color: #212529;
        }

        .btn-restore:hover {
            background: #e0a800;
        }

        /* Estilos para campos de busca */
        .search-input {
            padding: 10px 15px 10px 15px !important;
            border: 2px solid #e3e6f0 !important;
            border-radius: 25px !important;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            border-color: #6598D2 !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
            outline: none;
        }

        .search-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }

        .clear-search {
            background: #6c757d !important;
            color: white !important;
            border: none !important;
            padding: 8px 12px !important;
            border-radius: 20px !important;
            font-size: 12px !important;
            margin-left: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-search:hover {
            background: #545b62 !important;
        }

        .search-results-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
            color: #495057;
            border-left: 4px solid #6598D2;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            font-style: italic;
        }
    </style>

    <script>
        let currentData = {};

        // Verificar autenticação ao carregar
        document.addEventListener('DOMContentLoaded', function () {
            verificarAuth();
        });

        function verificarAuth() {
            const tempAuth = localStorage.getItem('admin_temp_auth');

            if (!tempAuth) {
                console.log('Sem credenciais temporárias, redirecionando...');
                window.location.href = 'LoginAdmin.html';
                return;
            }

            // Decodificar e verificar
            try {
                const decoded = atob(tempAuth);
                const [usuario, senha] = decoded.split(':');

                if (usuario === 'infofriends' && senha === '12345678') {
                    console.log('Credenciais válidas, mostrando painel...');
                    // Criar sessão no servidor para o PHP
                    fetch('GerenciadorAdmin.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ admin_temp_auth: tempAuth })
                    }).then(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        carregarDashboard();
                    });
                } else {
                    throw new Error('Credenciais inválidas');
                }
            } catch (error) {
                console.error('Erro na verificação:', error);
                localStorage.removeItem('admin_temp_auth');
                window.location.href = 'LoginAdmin.html';
            }
        }

        // Função auxiliar para fazer requisições à API
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            // Adicionar timestamp para evitar cache
            const timestamp = new Date().getTime();
            const baseUrl = `GerenciadorAdmin.php?action=${endpoint}`;
            const url = `${baseUrl}&_t=${timestamp}`;

            try {
                const response = await fetch(url, options);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                return result;
            } catch (error) {
                console.error('Erro na API:', error);
                alert('Erro: ' + error.message);
                throw error;
            }
        }

        function showSection(sectionId) {
            // Ocultar todas as seções
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => section.classList.remove('active'));

            // Remover active de todos os botões
            const buttons = document.querySelectorAll('.admin-nav button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Mostrar seção selecionada
            document.getElementById(sectionId).classList.add('active');
            const buttonId = 'btn' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            const button = document.getElementById(buttonId);
            if (button) button.classList.add('active');

            // Carregar dados específicos da seção
            switch (sectionId) {
                case 'dashboard':
                    carregarDashboard();
                    break;
                case 'eventos':
                    carregarEventos();
                    break;
                case 'usuarios':
                    carregarUsuarios();
                    break;
                case 'codigos':
                    carregarCodigos();
                    break;
                case 'certificados':
                    carregarCertificados();
                    break;
                case 'senhas':
                    carregarSolicitacoesSenha();
                    break;
                case 'backups':
                    carregarInfoBackups();
                    carregarListaBackups();
                    break;
            }
        }

        // =======================================
        // DASHBOARD
        // =======================================

        async function carregarDashboard() {
            try {
                const result = await apiCall('dashboard');
                const stats = result.data;

                document.getElementById('totalEventos').textContent = stats.eventos;
                document.getElementById('totalUsuarios').textContent = stats.usuarios;
                document.getElementById('totalOrganizadores').textContent = stats.organizadores;
                document.getElementById('totalCodigos').textContent = stats.codigos;

                // Estatísticas detalhadas
                let html = '<h5>Eventos por Categoria</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">';

                stats.eventos_por_categoria.forEach(cat => {
                    html += `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                        <strong>${cat.categoria}</strong><br>
                        <span style="font-size: 20px; color: #6598D2;">${cat.total}</span>
                    </div>`;
                });

                html += '</div><h5>Últimos Eventos</h5><ul>';

                stats.ultimos_eventos.forEach(evento => {
                    const data = new Date(evento.inicio).toLocaleDateString();
                    html += `<li><strong>${evento.nome}</strong> - ${data} (${evento.modalidade})</li>`;
                });

                html += '</ul>';

                document.getElementById('estatisticas').innerHTML = html;

            } catch (error) {
                document.getElementById('estatisticas').innerHTML = '<p style="color: red;">Erro ao carregar estatísticas.</p>';
            }
        }

        // =======================================
        // EVENTOS
        // =======================================

        async function carregarEventos() {
            try {
                const result = await apiCall('eventos');
                currentData.eventos = result.data;

                let html = '<div class="table-responsive"><table class="data-table">';
                html += '<thead><tr><th>ID</th><th>Nome</th><th>Categoria</th><th>Data Início</th><th>Local</th><th>Modalidade</th><th>Certificado</th><th>Ações</th></tr></thead><tbody>';

                result.data.forEach(evento => {
                    const dataInicio = new Date(evento.inicio).toLocaleDateString();
                    const certificado = evento.certificado ? 'Sim' : 'Não';

                    html += `<tr>
                        <td>${evento.cod_evento}</td>
                        <td><strong>${evento.nome}</strong></td>
                        <td><span class="status-badge status-ativo">${evento.categoria}</span></td>
                        <td>${dataInicio}</td>
                        <td>${evento.lugar}</td>
                        <td>${evento.modalidade}</td>
                        <td>${certificado}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="editarEvento(${evento.cod_evento})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg> Editar</button>
                            <button class="btn-small btn-delete" onclick="excluirEvento(${evento.cod_evento})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Excluir</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                document.getElementById('eventosContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('eventosContainer').innerHTML = '<p style="color: red;">Erro ao carregar eventos.</p>';
            }
        }

        // =======================================
        // USUÁRIOS
        // =======================================

        async function carregarUsuarios() {
            try {
                // Limpar dados antigos para forçar reload
                currentData.usuarios = [];

                // Mostrar loading
                document.getElementById('usuariosContainer').innerHTML = '<p>🔄 Carregando usuários...</p>';

                const result = await apiCall('usuarios');
                currentData.usuarios = result.data;

                // Usa a nova função de renderização
                renderizarUsuarios(currentData.usuarios);

                console.log('Usuários carregados:', currentData.usuarios.length);

            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                document.getElementById('usuariosContainer').innerHTML = '<p style="color: red;">Erro ao carregar usuários.</p>';
            }
        }

        // =======================================
        // CÓDIGOS
        // =======================================

        async function carregarCodigos() {
            try {
                // Limpar dados antigos para forçar reload
                currentData.codigos = [];

                // Mostrar loading
                document.getElementById('codigosContainer').innerHTML = '<p>🔄 Carregando códigos...</p>';

                const result = await apiCall('codigos');
                currentData.codigos = result.data;

                // Usa a nova função de renderização
                renderizarCodigos(currentData.codigos);

                console.log('Códigos carregados:', currentData.codigos.length);

            } catch (error) {
                console.error('Erro ao carregar códigos:', error);
                document.getElementById('codigosContainer').innerHTML = '<p style="color: red;">Erro ao carregar códigos.</p>';
            }
        }

        // =======================================
        // CERTIFICADOS
        // =======================================

        async function carregarCertificados() {
            try {
                const result = await apiCall('certificados');
                currentData.certificados = result.data;

                let html = '<div class="table-responsive"><table class="data-table">';
                html += '<thead><tr><th>Código Verificação</th><th>Modelo</th><th>Tipo</th><th>Ações</th></tr></thead><tbody>';

                result.data.forEach(cert => {
                    html += `<tr>
                        <td><strong>${cert.cod_verificacao}</strong></td>
                        <td>${cert.modelo}</td>
                        <td>${cert.tipo}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="validarCertificado('${cert.cod_verificacao}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Validar</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                document.getElementById('certificadosContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('certificadosContainer').innerHTML = '<p style="color: red;">Erro ao carregar certificados.</p>';
            }
        }

        // =======================================
        // AÇÕES DOS BOTÕES
        // =======================================

        async function gerarNovoCodigo() {
            // Pergunta se quer gerar automaticamente ou inserir manualmente
            const opcao = confirm('GERAÇÃO DE CÓDIGO\n\nOK = Gerar código automático (seguro)\nCancelar = Inserir código manualmente');

            let codigo = '';
            if (!opcao) {
                // Modo manual
                codigo = prompt('CÓDIGO MANUAL\n\nDigite o código (exatamente 8 caracteres):\n• Letras: A-Z (exceto I, O)\n• Números: 2-9 (exceto 0, 1)\n\nExemplo: AB3C5XYZ');
                if (!codigo) return; // Cancelou

                codigo = codigo.toUpperCase().trim();
                if (codigo.length !== 8) {
                    alert('ERRO: O código deve ter exatamente 8 caracteres!\n\nVocê digitou: ' + codigo.length + ' caracteres');
                    return;
                }

                if (!/^[ABCDEFGHJKLMNPQRSTUVWXYZ23456789]{8}$/.test(codigo)) {
                    alert('FORMATO INVÁLIDO!\n\nUse apenas:\n• Letras: A, B, C, D, E, F, G, H, J, K, L, M, N, P, Q, R, S, T, U, V, W, X, Y, Z\n• Números: 2, 3, 4, 5, 6, 7, 8, 9\n\n(Sem: I, O, 0, 1)');
                    return;
                }
            }

            // Pergunta pelas observações SEPARADAMENTE
            const observacoes = prompt('OBSERVAÇÕES (opcional)\n\nDescreva o propósito deste código:\n(deixe vazio se não quiser observações)') || '';

            try {
                const payload = { observacoes };
                if (codigo) {
                    payload.codigo = codigo;
                    console.log('Enviando código manual:', codigo);
                } else {
                    console.log('Gerando código automático');
                }

                console.log('Payload completo:', payload);

                const response = await apiCall('codigos', 'POST', payload);
                alert('CÓDIGO CRIADO COM SUCESSO!\n\nCódigo: ' + response.codigo + '\nObservações: ' + (observacoes || 'Nenhuma') + '\n\nEste código é único e seguro!');
                carregarCodigos();
            } catch (error) {
                console.error('Erro ao criar código:', error);
                alert('Erro ao criar código. Verifique o console para detalhes.');
            }
        }

        async function toggleCodigo(id, novoStatus) {
            try {
                // Garantir que novoStatus seja um boolean válido
                const ativo = Boolean(novoStatus);
                const action = ativo ? 'ativar' : 'desativar';

                if (confirm(`Confirma ${action} este código?`)) {
                    await apiCall('codigos', 'PUT', {
                        id: parseInt(id),
                        ativo: ativo,
                        observacoes: ''
                    });
                    alert(`Código ${ativo ? 'ativado' : 'desativado'} com sucesso!`);
                    carregarCodigos();
                }
            } catch (error) {
                console.error('Erro ao alterar status do código:', error);
                alert('Erro ao alterar status do código');
            }
        }

        async function excluirCodigo(id) {
            if (confirm('Tem certeza que deseja excluir este código?')) {
                try {
                    await apiCall(`codigos&id=${id}`, 'DELETE');
                    carregarCodigos();
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            }
        }

        async function toggleOrganizador(cpf, novoStatus) {
            let codigo = null;
            if (novoStatus) {
                codigo = prompt('Digite o código de organizador para este usuário:');
                if (!codigo) return;
            }

            try {
                await apiCall('usuarios', 'PUT', { CPF: cpf, Organizador: novoStatus, Codigo: codigo });
                carregarUsuarios();
            } catch (error) {
                // Erro já tratado na função apiCall
            }
        }

        async function excluirUsuario(cpf) {
            if (confirm('Tem certeza que deseja excluir este usuário? Esta ação não pode ser desfeita.')) {
                try {
                    await apiCall(`usuarios&id=${cpf}`, 'DELETE');
                    carregarUsuarios();
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            }
        }

        async function excluirEvento(id) {
            if (confirm('Tem certeza que deseja excluir este evento?')) {
                try {
                    await apiCall(`eventos&id=${id}`, 'DELETE');
                    carregarEventos();
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            }
        }

        // =======================================
        // MODAL DE EVENTOS
        // =======================================

        function showModalEvento(eventoId = null) {
            document.getElementById('modalEvento').style.display = 'block';

            if (eventoId) {
                // Editar evento existente
                const evento = currentData.eventos.find(e => e.cod_evento == eventoId);
                if (evento) {
                    document.getElementById('modalEventoTitle').textContent = 'Editar Evento';
                    document.getElementById('cod_evento').value = evento.cod_evento;
                    document.getElementById('categoria').value = evento.categoria;
                    document.getElementById('nome').value = evento.nome;
                    document.getElementById('lugar').value = evento.lugar;
                    document.getElementById('modalidade').value = evento.modalidade;
                    document.getElementById('descricao').value = evento.descricao;
                    document.getElementById('publico_alvo').value = evento.publico_alvo;
                    document.getElementById('duracao').value = evento.duracao;
                    document.getElementById('inicio').value = evento.inicio.slice(0, 16);
                    document.getElementById('conclusao').value = evento.conclusao.slice(0, 16);
                    document.getElementById('certificado').checked = evento.certificado == 1;
                }
            } else {
                // Novo evento
                document.getElementById('modalEventoTitle').textContent = 'Novo Evento';
                document.getElementById('formEvento').reset();
            }
        }

        function fecharModalEvento() {
            document.getElementById('modalEvento').style.display = 'none';
        }

        function editarEvento(id) {
            showModalEvento(id);
        }

        // =======================================
        // MODAL DE USUÁRIOS
        // =======================================

        function showModalUsuario() {
            document.getElementById('modalUsuario').style.display = 'block';
            document.getElementById('modalUsuarioTitle').textContent = 'Novo Usuário';
            document.getElementById('formUsuario').reset();
            document.getElementById('codigoOrganizadorField').style.display = 'none';
            document.getElementById('usuario_codigo').required = false;
        }

        function fecharModalUsuario() {
            document.getElementById('modalUsuario').style.display = 'none';
        }

        function toggleCodigoOrganizador() {
            const organizador = document.getElementById('usuario_organizador').value;
            const codigoField = document.getElementById('codigoOrganizadorField');
            const codigoInput = document.getElementById('usuario_codigo');

            if (organizador === '1') {
                codigoField.style.display = 'block';
                codigoInput.required = true;
            } else {
                codigoField.style.display = 'none';
                codigoInput.required = false;
                codigoInput.value = '';
            }
        }

        async function criarUsuario(data) {
            try {
                await apiCall('usuarios', 'POST', data);
                fecharModalUsuario();
                carregarUsuarios();
                alert('Usuário criado com sucesso!');
            } catch (error) {
                console.error('Erro ao criar usuário:', error);
            }
        }

        // Form submission
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('formEvento').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Adicionar campos não capturados pelo FormData
                data.cod_evento = document.getElementById('cod_evento').value;
                data.categoria = document.getElementById('categoria').value;
                data.nome = document.getElementById('nome').value;
                data.lugar = document.getElementById('lugar').value;
                data.modalidade = document.getElementById('modalidade').value;
                data.descricao = document.getElementById('descricao').value;
                data.publico_alvo = document.getElementById('publico_alvo').value;
                data.duracao = document.getElementById('duracao').value;
                data.inicio = document.getElementById('inicio').value;
                data.conclusao = document.getElementById('conclusao').value;
                data.certificado = document.getElementById('certificado').checked;

                try {
                    // Verificar se é edição ou criação
                    const isEdit = currentData.eventos && currentData.eventos.some(e => e.cod_evento == data.cod_evento);

                    if (isEdit) {
                        await apiCall('eventos', 'PUT', data);
                    } else {
                        await apiCall('eventos', 'POST', data);
                    }

                    fecharModalEvento();
                    carregarEventos();
                    alert('Evento salvo com sucesso!');
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            });

            // Form submission para Usuário
            document.getElementById('formUsuario').addEventListener('submit', async function (e) {
                e.preventDefault();

                // Validar senhas
                const senha = document.getElementById('usuario_senha').value;
                const confirmaSenha = document.getElementById('usuario_confirma_senha').value;

                if (senha !== confirmaSenha) {
                    alert('As senhas não coincidem!');
                    return;
                }

                // Validar CPF (11 dígitos)
                const cpf = document.getElementById('usuario_cpf').value;
                if (!/^\d{11}$/.test(cpf)) {
                    alert('CPF deve conter exatamente 11 dígitos numéricos!');
                    return;
                }

                // Validar RA (7 dígitos ou vazio)
                const ra = document.getElementById('usuario_ra').value;
                if (ra && !/^\d{7}$/.test(ra)) {
                    alert('RA deve conter exatamente 7 dígitos numéricos ou ser deixado em branco!');
                    return;
                }

                const formData = new FormData(this);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    if (key !== 'confirma_senha') { // Não enviar confirmação de senha
                        data[key] = value;
                    }
                }

                // Converter organizador para número
                data.organizador = parseInt(data.organizador);

                try {
                    await apiCall('usuarios', 'POST', data);
                    fecharModalUsuario();
                    carregarUsuarios();
                    alert('Usuário criado com sucesso!');
                } catch (error) {
                    // Erro já tratado na função apiCall
                }
            });
        });

        function exportarEventos() {
            alert('Funcionalidade de exportação será implementada em breve.');
        }

        function exportarUsuarios() {
            alert('Funcionalidade de exportação será implementada em breve.');
        }

        function gerarCodigosLote() {
            const quantidade = prompt('Quantos códigos deseja gerar?');
            if (quantidade && parseInt(quantidade) > 0) {
                alert(`Funcionalidade de geração em lote será implementada. Solicitado: ${quantidade} códigos.`);
            }
        }

        function validarCertificados() {
            alert('Funcionalidade de validação será implementada em breve.');
        }

        function validarCertificado(codigo) {
            alert(`Validando certificado: ${codigo}`);
        }

        // =======================================
        // SOLICITAÇÕES DE SENHA
        // =======================================

        async function carregarSolicitacoesSenha() {
            try {
                const filtroStatus = document.getElementById('filtroStatusSenha')?.value || 'pendente';

                // Mostrar loading
                document.getElementById('senhasContainer').innerHTML = '<p>🔄 Carregando solicitações...</p>';

                const result = await apiCall(`senhas&status=${filtroStatus}`);
                currentData.senhas = result.data;

                renderizarSolicitacoesSenha(currentData.senhas, result.meta);

                console.log('Solicitações de senha carregadas:', currentData.senhas.length);

            } catch (error) {
                console.error('Erro ao carregar solicitações:', error);
                document.getElementById('senhasContainer').innerHTML = '<p style="color: red;">Erro ao carregar solicitações.</p>';
            }
        }

        function renderizarSolicitacoesSenha(solicitacoes, meta = {}) {
            let html = '';

            // Mostrar estatísticas
            if (meta.totais_por_status) {
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                html += `<div class="stats-card" style="border-left-color: #ffc107;">
                    <h4 style="color: #ffc107;"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg> Pendentes</h4>
                    <p>${meta.totais_por_status.pendente || 0}</p>
                </div>`;
                html += `<div class="stats-card" style="border-left-color: #28a745;">
                    <h4 style="color: #28a745;"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Resolvidas</h4>
                    <p>${meta.totais_por_status.resolvida || 0}</p>
                </div>`;
                html += `<div class="stats-card" style="border-left-color: var(--vermelho);">
                    <h4 style="color: var(--vermelho);"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Canceladas</h4>
                    <p>${meta.totais_por_status.cancelada || 0}</p>
                </div>`;
                html += '</div>';
            }

            html += '<div class="table-responsive"><table class="data-table">';
            html += '<thead><tr><th>ID</th><th>Email</th><th>Nome Usuário</th><th>CPF</th><th>Data Solicitação</th><th>Status</th><th>Ações</th></tr></thead><tbody>';

            if (solicitacoes.length === 0) {
                html += '<tr><td colspan="7" class="no-results">Nenhuma solicitação encontrada</td></tr>';
            } else {
                solicitacoes.forEach(solicitacao => {
                    const dataSolicitacao = new Date(solicitacao.data_solicitacao).toLocaleString('pt-BR');
                    let statusClass = 'status-ativo';
                    let statusIcon = '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>';

                    if (solicitacao.status === 'resolvida') {
                        statusClass = 'status-ativo';
                        statusIcon = '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>';
                    } else if (solicitacao.status === 'cancelada') {
                        statusClass = 'status-inativo';
                        statusIcon = '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
                    } else if (solicitacao.status === 'pendente') {
                        statusClass = 'status-usado';
                        statusIcon = '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>';
                    }

                    const nomeUsuario = solicitacao.nome_usuario || '<em>Usuário não encontrado</em>';
                    const cpf = solicitacao.CPF || '<em>N/A</em>';

                    html += `<tr>
                        <td>${solicitacao.id}</td>
                        <td><strong>${solicitacao.email}</strong></td>
                        <td>${nomeUsuario}</td>
                        <td>${cpf}</td>
                        <td>${dataSolicitacao}</td>
                        <td><span class="status-badge ${statusClass}">${statusIcon} ${solicitacao.status}</span></td>
                        <td>`;

                    if (solicitacao.status === 'pendente' && solicitacao.CPF) {
                        html += `<button class="btn-small btn-edit" onclick="modalRedefinirSenha(${solicitacao.id}, '${solicitacao.CPF}', '${solicitacao.email}', '${(solicitacao.nome_usuario || '').replace(/'/g, "\\'")}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12.65 10C11.7 7.31 8.9 5.5 5.77 6.12c-2.29.46-4.15 2.29-4.63 4.58C.32 14.57 3.26 18 7 18c2.61 0 4.83-1.67 5.65-4H17v2c0 1.1.9 2 2 2s2-.9 2-2v-2c1.1 0 2-.9 2-2s-.9-2-2-2h-8.35zM7 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg> Redefinir</button> `;
                    }

                    if (solicitacao.status === 'pendente') {
                        html += `<button class="btn-small btn-delete" onclick="cancelarSolicitacaoSenha(${solicitacao.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> Cancelar</button>`;
                    }

                    if (solicitacao.status === 'resolvida' && solicitacao.observacoes) {
                        html += `<button class="btn-small btn-toggle" onclick="verObservacoes('${(solicitacao.observacoes || '').replace(/'/g, "\\'")}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> Ver Obs</button>`;
                    }

                    html += `</td></tr>`;
                });
            }

            html += '</tbody></table></div>';
            html += `<div class="search-results-info">Mostrando ${solicitacoes.length} solicitações</div>`;
            document.getElementById('senhasContainer').innerHTML = html;
        }

        function modalRedefinirSenha(id, cpf, email, nome) {
            const novaSenha = prompt(
                `REDEFINIR SENHA\n\n` +
                `Usuário: ${nome}\n` +
                `Email: ${email}\n` +
                `CPF: ${cpf}\n\n` +
                `Digite a NOVA SENHA para este usuário:`
            );

            if (!novaSenha) return;

            if (novaSenha.length < 6) {
                alert('A senha deve ter no mínimo 6 caracteres!');
                return;
            }

            const observacoes = prompt(
                `OBSERVAÇÕES (opcional)\n\n` +
                `Adicione alguma observação sobre esta redefinição:\n` +
                `(deixe vazio se não quiser adicionar)`
            ) || `Senha redefinida pelo admin em ${new Date().toLocaleString('pt-BR')}`;

            if (confirm(`CONFIRMAR REDEFINIÇÃO\n\nUsuário: ${nome}\nEmail: ${email}\nNova Senha: ${'*'.repeat(novaSenha.length)}\n\nDeseja continuar?`)) {
                resolverSolicitacaoSenha(id, cpf, novaSenha, observacoes);
            }
        }

        async function resolverSolicitacaoSenha(id, cpf, novaSenha, observacoes) {
            try {
                await apiCall('senhas', 'POST', {
                    id: id,
                    cpf: cpf,
                    nova_senha: novaSenha,
                    observacoes: observacoes
                });

                alert('Senha redefinida com sucesso!\n\nO usuário já pode fazer login com a nova senha.');
                carregarSolicitacoesSenha();
            } catch (error) {
                console.error('Erro ao resolver solicitação:', error);
                alert('Erro ao redefinir senha. Verifique o console.');
            }
        }

        async function cancelarSolicitacaoSenha(id) {
            if (confirm('Tem certeza que deseja cancelar esta solicitação?\n\nEsta ação não pode ser desfeita.')) {
                try {
                    await apiCall(`senhas&id=${id}`, 'DELETE');
                    alert('Solicitação cancelada com sucesso!');
                    carregarSolicitacoesSenha();
                } catch (error) {
                    console.error('Erro ao cancelar solicitação:', error);
                }
            }
        }

        function verObservacoes(obs) {
            alert('OBSERVAÇÕES\n\n' + obs);
        }

        // =======================================
        // FUNCIONALIDADES DE BUSCA
        // =======================================

        // Variáveis para controle de timeout de busca
        let timeoutBuscaUsuarios = null;
        let timeoutBuscaCodigos = null;

        // Função para buscar usuários
        function buscarUsuarios() {
            // Limpa timeout anterior
            if (timeoutBuscaUsuarios) {
                clearTimeout(timeoutBuscaUsuarios);
            }

            // Define novo timeout para evitar muitas requisições
            timeoutBuscaUsuarios = setTimeout(() => {
                const termo = document.getElementById('searchUsuarios').value.trim().toLowerCase();

                if (!currentData.usuarios) {
                    console.log('Dados de usuários não carregados');
                    return;
                }

                let usuariosFiltrados = currentData.usuarios;

                if (termo) {
                    usuariosFiltrados = currentData.usuarios.filter(usuario => {
                        return (
                            usuario.Nome.toLowerCase().includes(termo) ||
                            usuario.CPF.includes(termo) ||
                            usuario.Email.toLowerCase().includes(termo) ||
                            (usuario.RA && usuario.RA.includes(termo))
                        );
                    });
                }

                renderizarUsuarios(usuariosFiltrados);
            }, 300); // 300ms de delay
        }

        // Função para buscar códigos
        function buscarCodigos() {
            // Limpa timeout anterior
            if (timeoutBuscaCodigos) {
                clearTimeout(timeoutBuscaCodigos);
            }

            // Define novo timeout para evitar muitas requisições
            timeoutBuscaCodigos = setTimeout(() => {
                const termo = document.getElementById('searchCodigos').value.trim().toUpperCase();

                if (!currentData.codigos) {
                    console.log('Dados de códigos não carregados');
                    return;
                }

                let codigosFiltrados = currentData.codigos;

                if (termo) {
                    codigosFiltrados = currentData.codigos.filter(codigo => {
                        return (
                            codigo.codigo.includes(termo) ||
                            (codigo.observacoes && codigo.observacoes.toLowerCase().includes(termo.toLowerCase())) ||
                            (codigo.usado_por && codigo.usado_por.toLowerCase().includes(termo.toLowerCase())) ||
                            codigo.id.toString() === termo
                        );
                    });
                }

                renderizarCodigos(codigosFiltrados);
            }, 300); // 300ms de delay
        }

        // Função para renderizar usuários filtrados
        function renderizarUsuarios(usuarios) {
            let html = '<div class="table-responsive"><table class="data-table">';
            html += '<thead><tr><th>CPF</th><th>Nome</th><th>Email</th><th>RA</th><th>Organizador</th><th>Código</th><th>Ações</th></tr></thead><tbody>';

            if (usuarios.length === 0) {
                html += '<tr><td colspan="7" class="no-results">Nenhum usuário encontrado com os critérios de busca</td></tr>';
            } else {
                usuarios.forEach(usuario => {
                    const organizador = usuario.Organizador ? 'Sim' : 'Não';
                    const statusClass = usuario.Organizador ? 'status-ativo' : 'status-inativo';

                    html += `<tr>
                        <td>${usuario.CPF}</td>
                        <td><strong>${usuario.Nome}</strong></td>
                        <td>${usuario.Email}</td>
                        <td>${usuario.RA || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${organizador}</span></td>
                        <td>${usuario.Codigo || '-'}</td>
                        <td>
                            <button class="btn-small btn-toggle" onclick="toggleOrganizador('${usuario.CPF}', ${!usuario.Organizador})">
                                ${usuario.Organizador ? '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg> Remover Org' : '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg> Tornar Org'}
                            </button>
                            <button class="btn-small btn-delete" onclick="excluirUsuario('${usuario.CPF}')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Excluir</button>
                        </td>
                    </tr>`;
                });
            }

            html += '</tbody></table></div>';
            html += `<div class="search-results-info">Mostrando ${usuarios.length} de ${currentData.usuarios.length} usuários</div>`;
            document.getElementById('usuariosContainer').innerHTML = html;
        }

        // Função para renderizar códigos filtrados
        function renderizarCodigos(codigos) {
            let html = '<div class="table-responsive"><table class="data-table">';
            html += '<thead><tr><th>ID</th><th>Código</th><th>Status</th><th>Usado</th><th>Data Criação</th><th>Usado Por</th><th>Observações</th><th>Ações</th></tr></thead><tbody>';

            if (codigos.length === 0) {
                html += '<tr><td colspan="8" class="no-results">Nenhum código encontrado com os critérios de busca</td></tr>';
            } else {
                codigos.forEach(codigo => {
                    const ativo = codigo.ativo == 1 ? 'Ativo' : 'Inativo';
                    const usado = codigo.usado == 1 ? 'Sim' : 'Não';
                    const statusClass = codigo.ativo == 1 ? (codigo.usado == 1 ? 'status-usado' : 'status-ativo') : 'status-inativo';
                    const dataCriacao = new Date(codigo.data_criacao).toLocaleDateString();

                    html += `<tr>
                        <td>${codigo.id}</td>
                        <td><strong>${codigo.codigo}</strong></td>
                        <td><span class="status-badge ${statusClass}">${ativo}</span></td>
                        <td>${usado}</td>
                        <td>${dataCriacao}</td>
                        <td>${codigo.usado_por || '-'}</td>
                        <td>${codigo.observacoes || '-'}</td>
                        <td>
                            <button class="btn-small btn-toggle" onclick="toggleCodigo(${codigo.id}, ${codigo.ativo == 1 ? 0 : 1})">
                                ${codigo.ativo == 1 ? '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg> Desativar' : '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/></svg> Ativar'}
                            </button>
                            <button class="btn-small btn-delete" onclick="excluirCodigo(${codigo.id})"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Excluir</button>
                        </td>
                    </tr>`;
                });
            }

            html += '</tbody></table></div>';
            html += `<div class="search-results-info">Mostrando ${codigos.length} de ${currentData.codigos.length} códigos</div>`;
            document.getElementById('codigosContainer').innerHTML = html;
        }

        // Funções para limpar buscas
        function limparBuscaUsuarios() {
            document.getElementById('searchUsuarios').value = '';
            if (currentData.usuarios) {
                renderizarUsuarios(currentData.usuarios);
            }
        }

        function limparBuscaCodigos() {
            document.getElementById('searchCodigos').value = '';
            if (currentData.codigos) {
                renderizarCodigos(currentData.codigos);
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                localStorage.removeItem('admin_temp_auth');
                window.location.href = 'LoginAdmin.html';
            }
        }

        // =======================================
        // BACKUPS
        // =======================================

        async function carregarInfoBackups() {
            try {
                const response = await fetch('GerenciadorBackup.php?acao=info');
                const data = await response.json();

                if (data.sucesso) {
                    document.getElementById('infoBDTamanho').textContent = data.tamanho;
                }
            } catch (e) {
                console.error('Erro ao carregar info:', e);
            }
        }

        async function carregarBackups() {
            const btn = event.target;
            btn.disabled = true;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg> Processando...';

            try {
                const response = await fetch('GerenciadorBackup.php?acao=fazer-backup', { method: 'POST' });
                const data = await response.json();

                if (data.sucesso) {
                    alert('✓ Backup realizado com sucesso!');
                    await carregarListaBackups();
                    await carregarInfoBackups();
                } else {
                    alert('✗ Erro: ' + data.mensagem);
                }
            } catch (e) {
                alert('Erro ao fazer backup: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        async function carregarListaBackups() {
            try {
                const response = await fetch('GerenciadorBackup.php?acao=listar', { method: 'POST' });
                const data = await response.json();

                if (data.sucesso) {
                    document.getElementById('infoBDTotal').textContent = data.total;

                    let html = '';
                    if (data.total === 0) {
                        html = '<p style="text-align: center; padding: 20px; color: #999;">📁 Nenhum backup disponível</p>';
                    } else {
                        html = '<div class="table-responsive"><table class="data-table">';
                        html += '<thead><tr>';
                        html += '<th>Data/Hora</th>';
                        html += '<th>Tamanho</th>';
                        html += '<th>Ações</th>';
                        html += '</tr></thead><tbody>';

                        data.backups.forEach(backup => {
                            html += '<tr>';
                            html += '<td>' + backup.data + '</td>';
                            html += '<td>' + backup.tamanhoFormatado + '</td>';
                            html += '<td>';
                            html += '<button class="btn-small btn-download" onclick="baixarBackup(\'' + backup.nome + '\')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> Baixar</button> ';
                            html += '<button class="btn-small btn-restore" onclick="restaurarBackupConfirm(\'' + backup.nome + '\')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/></svg> Restaurar</button> ';
                            html += '<button class="btn-small btn-delete" onclick="deletarBackupConfirm(\'' + backup.nome + '\')"><svg class="icon icon-small" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg> Deletar</button>';
                            html += '</td>';
                            html += '</tr>';
                        });

                        html += '</tbody></table></div>';
                    }

                    document.getElementById('backupsContainer').innerHTML = html;
                } else {
                    document.getElementById('backupsContainer').innerHTML = '<p style="color: red;">Erro ao carregar backups</p>';
                }
            } catch (e) {
                document.getElementById('backupsContainer').innerHTML = '<p style="color: red;">Erro: ' + e.message + '</p>';
            }
        }

        function baixarBackup(nome) {
            window.location.href = 'GerenciadorBackup.php?acao=baixar&arquivo=' + encodeURIComponent(nome);
        }

        function restaurarBackupConfirm(nome) {
            if (!confirm('ATENÇÃO: Tem certeza? Isto vai RESTAURAR o banco de dados e SUBSTITUIR todos os dados atuais!')) {
                return;
            }
            restaurarBackup(nome);
        }

        async function restaurarBackup(nome) {
            try {
                const formData = new FormData();
                formData.append('arquivo', nome);

                const response = await fetch('GerenciadorBackup.php?acao=restaurar', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.sucesso) {
                    alert('✓ Backup restaurado com sucesso!');
                    location.reload();
                } else {
                    alert('✗ Erro: ' + data.mensagem);
                }
            } catch (e) {
                alert('Erro ao restaurar: ' + e.message);
            }
        }

        function deletarBackupConfirm(nome) {
            if (!confirm('Tem certeza que deseja deletar este backup?')) {
                return;
            }
            deletarBackup(nome);
        }

        async function deletarBackup(nome) {
            try {
                const formData = new FormData();
                formData.append('arquivo', nome);

                const response = await fetch('GerenciadorBackup.php?acao=deletar', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.sucesso) {
                    alert('✓ Backup deletado com sucesso!');
                    await carregarListaBackups();
                } else {
                    alert('✗ Erro: ' + data.mensagem);
                }
            } catch (e) {
                alert('Erro ao deletar: ' + e.message);
            }
        }
    </script>
</body>

</html>