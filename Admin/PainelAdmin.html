<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - CEU</title>
    <link rel="stylesheet" href="../styleGlobal.css">
    <link rel="stylesheet" href="styleAdmin.css">
</head>

<body>
    <div class="admin-page-container">
        <div id="loadingScreen"
            style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--fundo); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div style="text-align: center; color: var(--branco);">
                <div
                    style="width: 50px; height: 50px; border: 3px solid var(--caixas); border-top: 3px solid var(--botao); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;">
                </div>
                <p>Carregando painel administrativo...</p>
            </div>
        </div>

        <div id="adminPanel" style="display: none;">
            <div class="admin-header">
                <h1>üîê Painel Administrativo - CEU</h1>
                <p class="subtitle">Sistema de Gerenciamento Completo</p>
            </div>

            <div class="admin-container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">

                <!-- Navega√ß√£o -->
                <div class="admin-nav"
                    style="display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; padding: 10px 0;">
                    <button id="btnDashboard" class="btn-secondary active" onclick="showSection('dashboard')">üìä
                        Dashboard</button>
                    <button id="btnEventos" class="btn-secondary" onclick="showSection('eventos')">üéØ Eventos</button>
                    <button id="btnUsuarios" class="btn-secondary" onclick="showSection('usuarios')">üë•
                        Usu√°rios</button>
                    <button id="btnCodigos" class="btn-secondary" onclick="showSection('codigos')">üé´ C√≥digos</button>
                    <button id="btnCertificados" class="btn-secondary" onclick="showSection('certificados')">üìú
                        Certificados</button>
                    <button id="btnSair" class="btn-secondary" onclick="logout()"
                        style="margin-left: auto; background: #dc3545;">üö™ Sair</button>
                </div>

                <!-- Dashboard -->
                <div id="dashboard" class="admin-section active">
                    <h3>üìä Dashboard do Sistema</h3>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="stats-card" style="border-left-color: #28a745;">
                            <h4 style="color: #28a745;">üéØ Total de Eventos</h4>
                            <p id="totalEventos">-</p>
                            <small>Eventos cadastrados no sistema</small>
                        </div>
                        <div class="stats-card" style="border-left-color: var(--botao);">
                            <h4 style="color: var(--botao);">üë• Total de Usu√°rios</h4>
                            <p id="totalUsuarios">-</p>
                            <small>Usu√°rios registrados</small>
                        </div>
                        <div class="stats-card" style="border-left-color: #ffc107;">
                            <h4 style="color: #ffc107;">üëë Organizadores</h4>
                            <p id="totalOrganizadores">-</p>
                            <small>Usu√°rios com perfil organizador</small>
                        </div>
                        <div class="stats-card" style="border-left-color: #dc3545;">
                            <h4 style="color: #dc3545;">üé´ C√≥digos Ativos</h4>
                            <p id="totalCodigos">-</p>
                            <small>C√≥digos de organizador dispon√≠veis</small>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 15px;">üìà Estat√≠sticas Recentes</h4>
                        <div id="estatisticas">Carregando estat√≠sticas...</div>
                    </div>
                </div>

                <!-- Gerenciamento de Eventos -->
                <div id="eventos" class="admin-section">
                    <h3>üéØ Gerenciamento de Eventos</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="showModalEvento()">‚ûï Novo Evento</button>
                        <button class="btn-secondary" onclick="carregarEventos()">üîÑ Atualizar</button>
                        <button class="btn-secondary" onclick="exportarEventos()">üìä Exportar</button>
                    </div>

                    <div class="admin-container" id="eventosContainer">
                        <p>Carregando eventos...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Usu√°rios -->
                <div id="usuarios" class="admin-section">
                    <h3>üë• Gerenciamento de Usu√°rios</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="carregarUsuarios()">üîÑ Atualizar</button>
                        <button class="btn-secondary" onclick="exportarUsuarios()">üìä Exportar</button>
                        <input type="text" id="searchUsuarios" placeholder="üîç Buscar por nome, CPF ou email..."
                            class="search-input" style="width: 350px;" oninput="buscarUsuarios()">
                        <button class="clear-search" onclick="limparBuscaUsuarios()">‚úñ Limpar</button>
                    </div>

                    <div class="admin-container" id="usuariosContainer">
                        <p>Carregando usu√°rios...</p>
                    </div>
                </div>

                <!-- Gerenciamento de C√≥digos -->
                <div id="codigos" class="admin-section">
                    <h3>üé´ Gerenciamento de C√≥digos</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-generate" onclick="gerarNovoCodigo()">‚ûï Gerar C√≥digo</button>
                        <button class="btn-secondary" onclick="carregarCodigos()">üîÑ Atualizar</button>
                        <button class="btn-secondary" onclick="gerarCodigosLote()">üì¶ Gerar em Lote</button>
                        <input type="text" id="searchCodigos" placeholder="üîç Buscar c√≥digo..." class="search-input"
                            style="width: 250px;" oninput="buscarCodigos()">
                        <button class="clear-search" onclick="limparBuscaCodigos()">‚úñ Limpar</button>
                    </div>

                    <div class="admin-container" id="codigosContainer">
                        <p>Carregando c√≥digos...</p>
                    </div>
                </div>

                <!-- Gerenciamento de Certificados -->
                <div id="certificados" class="admin-section">
                    <h3>üìú Gerenciamento de Certificados</h3>

                    <div
                        style="margin-top: 35px; margin-bottom: 20px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                        <button class="btn-secondary" onclick="carregarCertificados()">üîÑ Atualizar</button>
                        <button class="btn-secondary" onclick="validarCertificados()">‚úÖ Validar Todos</button>
                    </div>

                    <div class="admin-container" id="certificadosContainer">
                        <p>Carregando certificados...</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Modal para Eventos -->
    <div id="modalEvento"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000;">
        <div class="admin-container"
            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 600px; max-height: 80%; overflow-y: auto;">
            <h3 id="modalEventoTitle">Novo Evento</h3>
            <form id="formEvento">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                    <div class="form-group">
                        <label>C√≥digo do Evento:</label>
                        <input type="number" id="cod_evento" required>
                    </div>
                    <div class="form-group">
                        <label>Categoria:</label>
                        <select id="categoria" required>
                            <option value="">Selecione...</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Palestra">Palestra</option>
                            <option value="Curso">Curso</option>
                            <option value="Semana">Semana</option>
                            <option value="Minicurso">Minicurso</option>
                            <option value="Hackathon">Hackathon</option>
                            <option value="Confer√™ncia">Confer√™ncia</option>
                        </select>
                    </div>
                    <div class="form-group" style="grid-column: span 2;">
                        <label>Nome do Evento:</label>
                        <input type="text" id="nome" required>
                    </div>
                    <div class="form-group">
                        <label>Local:</label>
                        <input type="text" id="lugar" required>
                    </div>
                    <div class="form-group">
                        <label>Modalidade:</label>
                        <select id="modalidade" required>
                            <option value="Presencial">Presencial</option>
                            <option value="Online">Online</option>
                            <option value="H√≠brido">H√≠brido</option>
                        </select>
                    </div>
                    <div style="grid-column: span 2;">
                        <label>Descri√ß√£o:</label>
                        <textarea id="descricao"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px;"></textarea>
                    </div>
                    <div>
                        <label>P√∫blico Alvo:</label>
                        <input type="text" id="publico_alvo"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label>Dura√ß√£o (horas):</label>
                        <input type="number" step="0.5" id="duracao"
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label>Data/Hora In√≠cio:</label>
                        <input type="datetime-local" id="inicio" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div>
                        <label>Data/Hora Fim:</label>
                        <input type="datetime-local" id="conclusao" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label>
                            <input type="checkbox" id="certificado"> Gera Certificado
                        </label>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn-generate">Salvar Evento</button>
                    <button type="button" class="btn-secondary" onclick="fecharModalEvento()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Gerenciamento de C√≥digos -->
    <div id="codes" class="admin-section">
        <h3>üé´ Gerenciamento de C√≥digos</h3>

        <div style="margin-bottom: 20px;">
            <button class="btn-generate" onclick="gerarNovoCodigo()">‚ûï Gerar Novo C√≥digo</button>
            <button class="btn-secondary" onclick="carregarCodigos()">üîÑ Atualizar Lista</button>
        </div>

        <div id="codigosList" style="background: white; border-radius: 10px; padding: 20px;">
            <p>Carregando c√≥digos...</p>
        </div>
    </div>

    <!-- √Årea de Teste -->
    <div id="test" class="admin-section">
        <h3>üß™ √Årea de Teste</h3>

        <div style="background: white; padding: 20px; border-radius: 10px;">
            <h4>Teste de Funcionalidades</h4>

            <div style="margin: 15px 0;">
                <button class="btn-test" onclick="testarConexaoBD()">üóÑÔ∏è Testar Banco de Dados</button>
                <button class="btn-test" onclick="testarSessao()">üë§ Testar Sess√£o</button>
                <button class="btn-test" onclick="testarLogs()">üìù Verificar Logs</button>
            </div>

            <div id="testResults"
                style="background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; min-height: 100px; margin-top: 15px;">
                Clique em um dos bot√µes acima para executar testes.
            </div>
        </div>
    </div>

    </div>
    </div>
    </div>

    <style>
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .admin-nav button.active {
            background: #28a745 !important;
            transform: scale(1.05);
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .data-table tr:hover {
            background-color: #f5f5f5;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-ativo {
            background: #d4edda;
            color: #155724;
        }

        .status-inativo {
            background: #f8d7da;
            color: #721c24;
        }

        .status-usado {
            background: #fff3cd;
            color: #856404;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            margin: 2px;
        }

        .btn-edit {
            background: #007bff;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-toggle {
            background: #ffc107;
            color: #212529;
        }

        /* Estilos para campos de busca */
        .search-input {
            padding: 10px 15px 10px 15px !important;
            border: 2px solid #e3e6f0 !important;
            border-radius: 25px !important;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            border-color: #007bff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
            outline: none;
        }

        .search-input::placeholder {
            color: #6c757d;
            font-style: italic;
        }

        .clear-search {
            background: #6c757d !important;
            color: white !important;
            border: none !important;
            padding: 8px 12px !important;
            border-radius: 20px !important;
            font-size: 12px !important;
            margin-left: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .clear-search:hover {
            background: #545b62 !important;
        }

        .search-results-info {
            margin-top: 10px;
            padding: 8px 12px;
            background: #e9ecef;
            border-radius: 6px;
            font-size: 0.9em;
            color: #495057;
            border-left: 4px solid #007bff;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
        }
    </style>

    <script>
        let currentData = {};

        // Verificar autentica√ß√£o ao carregar
        document.addEventListener('DOMContentLoaded', function () {
            verificarAuth();
        });

        function verificarAuth() {
            const tempAuth = localStorage.getItem('admin_temp_auth');

            if (!tempAuth) {
                console.log('Sem credenciais tempor√°rias, redirecionando...');
                window.location.href = 'LoginAdmin.html';
                return;
            }

            // Decodificar e verificar
            try {
                const decoded = atob(tempAuth);
                const [usuario, senha] = decoded.split(':');

                if (usuario === 'infofriends' && senha === '12345678') {
                    console.log('Credenciais v√°lidas, mostrando painel...');
                    // Criar sess√£o no servidor para o PHP
                    fetch('GerenciadorAdmin.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ admin_temp_auth: tempAuth })
                    }).then(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        carregarDashboard();
                    });
                } else {
                    throw new Error('Credenciais inv√°lidas');
                }
            } catch (error) {
                console.error('Erro na verifica√ß√£o:', error);
                localStorage.removeItem('admin_temp_auth');
                window.location.href = 'LoginAdmin.html';
            }
        }

        // Fun√ß√£o auxiliar para fazer requisi√ß√µes √† API
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                    'Pragma': 'no-cache',
                    'Expires': '0'
                },
                credentials: 'same-origin'
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            // Adicionar timestamp para evitar cache
            const timestamp = new Date().getTime();
            const baseUrl = `GerenciadorAdmin.php?action=${endpoint}`;
            const url = `${baseUrl}&_t=${timestamp}`;

            try {
                const response = await fetch(url, options);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                return result;
            } catch (error) {
                console.error('Erro na API:', error);
                alert('Erro: ' + error.message);
                throw error;
            }
        }

        function showSection(sectionId) {
            // Ocultar todas as se√ß√µes
            const sections = document.querySelectorAll('.admin-section');
            sections.forEach(section => section.classList.remove('active'));

            // Remover active de todos os bot√µes
            const buttons = document.querySelectorAll('.admin-nav button');
            buttons.forEach(btn => btn.classList.remove('active'));

            // Mostrar se√ß√£o selecionada
            document.getElementById(sectionId).classList.add('active');
            const buttonId = 'btn' + sectionId.charAt(0).toUpperCase() + sectionId.slice(1);
            const button = document.getElementById(buttonId);
            if (button) button.classList.add('active');

            // Carregar dados espec√≠ficos da se√ß√£o
            switch (sectionId) {
                case 'dashboard':
                    carregarDashboard();
                    break;
                case 'eventos':
                    carregarEventos();
                    break;
                case 'usuarios':
                    carregarUsuarios();
                    break;
                case 'codigos':
                    carregarCodigos();
                    break;
                case 'certificados':
                    carregarCertificados();
                    break;
            }
        }

        // =======================================
        // DASHBOARD
        // =======================================

        async function carregarDashboard() {
            try {
                const result = await apiCall('dashboard');
                const stats = result.data;

                document.getElementById('totalEventos').textContent = stats.eventos;
                document.getElementById('totalUsuarios').textContent = stats.usuarios;
                document.getElementById('totalOrganizadores').textContent = stats.organizadores;
                document.getElementById('totalCodigos').textContent = stats.codigos;

                // Estat√≠sticas detalhadas
                let html = '<h5>üìä Eventos por Categoria</h5>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;">';

                stats.eventos_por_categoria.forEach(cat => {
                    html += `<div style="background: #f8f9fa; padding: 10px; border-radius: 5px; text-align: center;">
                        <strong>${cat.categoria}</strong><br>
                        <span style="font-size: 20px; color: #007bff;">${cat.total}</span>
                    </div>`;
                });

                html += '</div><h5>üïí √öltimos Eventos</h5><ul>';

                stats.ultimos_eventos.forEach(evento => {
                    const data = new Date(evento.inicio).toLocaleDateString();
                    html += `<li><strong>${evento.nome}</strong> - ${data} (${evento.modalidade})</li>`;
                });

                html += '</ul>';

                document.getElementById('estatisticas').innerHTML = html;

            } catch (error) {
                document.getElementById('estatisticas').innerHTML = '<p style="color: red;">Erro ao carregar estat√≠sticas.</p>';
            }
        }

        // =======================================
        // EVENTOS
        // =======================================

        async function carregarEventos() {
            try {
                const result = await apiCall('eventos');
                currentData.eventos = result.data;

                let html = '<div class="table-responsive"><table class="data-table">';
                html += '<thead><tr><th>ID</th><th>Nome</th><th>Categoria</th><th>Data In√≠cio</th><th>Local</th><th>Modalidade</th><th>Certificado</th><th>A√ß√µes</th></tr></thead><tbody>';

                result.data.forEach(evento => {
                    const dataInicio = new Date(evento.inicio).toLocaleDateString();
                    const certificado = evento.certificado ? 'Sim' : 'N√£o';

                    html += `<tr>
                        <td>${evento.cod_evento}</td>
                        <td><strong>${evento.nome}</strong></td>
                        <td><span class="status-badge status-ativo">${evento.categoria}</span></td>
                        <td>${dataInicio}</td>
                        <td>${evento.lugar}</td>
                        <td>${evento.modalidade}</td>
                        <td>${certificado}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="editarEvento(${evento.cod_evento})">‚úèÔ∏è Editar</button>
                            <button class="btn-small btn-delete" onclick="excluirEvento(${evento.cod_evento})">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                document.getElementById('eventosContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('eventosContainer').innerHTML = '<p style="color: red;">Erro ao carregar eventos.</p>';
            }
        }

        // =======================================
        // USU√ÅRIOS
        // =======================================

        async function carregarUsuarios() {
            try {
                // Limpar dados antigos para for√ßar reload
                currentData.usuarios = [];

                // Mostrar loading
                document.getElementById('usuariosContainer').innerHTML = '<p>üîÑ Carregando usu√°rios...</p>';

                const result = await apiCall('usuarios');
                currentData.usuarios = result.data;

                // Usa a nova fun√ß√£o de renderiza√ß√£o
                renderizarUsuarios(currentData.usuarios);

                console.log('Usu√°rios carregados:', currentData.usuarios.length);

            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                document.getElementById('usuariosContainer').innerHTML = '<p style="color: red;">Erro ao carregar usu√°rios.</p>';
            }
        }

        // =======================================
        // C√ìDIGOS
        // =======================================

        async function carregarCodigos() {
            try {
                // Limpar dados antigos para for√ßar reload
                currentData.codigos = [];

                // Mostrar loading
                document.getElementById('codigosContainer').innerHTML = '<p>üîÑ Carregando c√≥digos...</p>';

                const result = await apiCall('codigos');
                currentData.codigos = result.data;

                // Usa a nova fun√ß√£o de renderiza√ß√£o
                renderizarCodigos(currentData.codigos);

                console.log('C√≥digos carregados:', currentData.codigos.length);

            } catch (error) {
                console.error('Erro ao carregar c√≥digos:', error);
                document.getElementById('codigosContainer').innerHTML = '<p style="color: red;">Erro ao carregar c√≥digos.</p>';
            }
        }

        // =======================================
        // CERTIFICADOS
        // =======================================

        async function carregarCertificados() {
            try {
                const result = await apiCall('certificados');
                currentData.certificados = result.data;

                let html = '<div class="table-responsive"><table class="data-table">';
                html += '<thead><tr><th>C√≥digo Verifica√ß√£o</th><th>Modelo</th><th>Tipo</th><th>A√ß√µes</th></tr></thead><tbody>';

                result.data.forEach(cert => {
                    html += `<tr>
                        <td><strong>${cert.cod_verificacao}</strong></td>
                        <td>${cert.modelo}</td>
                        <td>${cert.tipo}</td>
                        <td>
                            <button class="btn-small btn-edit" onclick="validarCertificado('${cert.cod_verificacao}')">‚úÖ Validar</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table></div>';
                document.getElementById('certificadosContainer').innerHTML = html;

            } catch (error) {
                document.getElementById('certificadosContainer').innerHTML = '<p style="color: red;">Erro ao carregar certificados.</p>';
            }
        }

        // =======================================
        // A√á√ïES DOS BOT√ïES
        // =======================================

        async function gerarNovoCodigo() {
            // Pergunta se quer gerar automaticamente ou inserir manualmente
            const opcao = confirm('üîê GERA√á√ÉO DE C√ìDIGO\n\n‚úÖ OK = Gerar c√≥digo autom√°tico (seguro)\n‚ùå Cancelar = Inserir c√≥digo manualmente');

            let codigo = '';
            if (!opcao) {
                // Modo manual
                codigo = prompt('üìù C√ìDIGO MANUAL\n\nDigite o c√≥digo (exatamente 8 caracteres):\n‚Ä¢ Letras: A-Z (exceto I, O)\n‚Ä¢ N√∫meros: 2-9 (exceto 0, 1)\n\nExemplo: AB3C5XYZ');
                if (!codigo) return; // Cancelou

                codigo = codigo.toUpperCase().trim();
                if (codigo.length !== 8) {
                    alert('‚ùå ERRO: O c√≥digo deve ter exatamente 8 caracteres!\n\nVoc√™ digitou: ' + codigo.length + ' caracteres');
                    return;
                }

                if (!/^[ABCDEFGHJKLMNPQRSTUVWXYZ23456789]{8}$/.test(codigo)) {
                    alert('‚ùå FORMATO INV√ÅLIDO!\n\nUse apenas:\n‚Ä¢ Letras: A, B, C, D, E, F, G, H, J, K, L, M, N, P, Q, R, S, T, U, V, W, X, Y, Z\n‚Ä¢ N√∫meros: 2, 3, 4, 5, 6, 7, 8, 9\n\n(Sem: I, O, 0, 1)');
                    return;
                }
            }

            // Pergunta pelas observa√ß√µes SEPARADAMENTE
            const observacoes = prompt('üìã OBSERVA√á√ïES (opcional)\n\nDescreva o prop√≥sito deste c√≥digo:\n(deixe vazio se n√£o quiser observa√ß√µes)') || '';

            try {
                const payload = { observacoes };
                if (codigo) {
                    payload.codigo = codigo;
                    console.log('Enviando c√≥digo manual:', codigo);
                } else {
                    console.log('Gerando c√≥digo autom√°tico');
                }

                console.log('Payload completo:', payload);

                const response = await apiCall('codigos', 'POST', payload);
                alert('‚úÖ C√ìDIGO CRIADO COM SUCESSO!\n\nüîë C√≥digo: ' + response.codigo + '\nüìã Observa√ß√µes: ' + (observacoes || 'Nenhuma') + '\n\nüîí Este c√≥digo √© √∫nico e seguro!');
                carregarCodigos();
            } catch (error) {
                console.error('Erro ao criar c√≥digo:', error);
                alert('‚ùå Erro ao criar c√≥digo. Verifique o console para detalhes.');
            }
        }

        async function toggleCodigo(id, novoStatus) {
            try {
                // Garantir que novoStatus seja um boolean v√°lido
                const ativo = Boolean(novoStatus);
                const action = ativo ? 'ativar' : 'desativar';

                if (confirm(`Confirma ${action} este c√≥digo?`)) {
                    await apiCall('codigos', 'PUT', {
                        id: parseInt(id),
                        ativo: ativo,
                        observacoes: ''
                    });
                    alert(`‚úÖ C√≥digo ${ativo ? 'ativado' : 'desativado'} com sucesso!`);
                    carregarCodigos();
                }
            } catch (error) {
                console.error('Erro ao alterar status do c√≥digo:', error);
                alert('‚ùå Erro ao alterar status do c√≥digo');
            }
        }

        async function excluirCodigo(id) {
            if (confirm('Tem certeza que deseja excluir este c√≥digo?')) {
                try {
                    await apiCall(`codigos&id=${id}`, 'DELETE');
                    carregarCodigos();
                } catch (error) {
                    // Erro j√° tratado na fun√ß√£o apiCall
                }
            }
        }

        async function toggleOrganizador(cpf, novoStatus) {
            let codigo = null;
            if (novoStatus) {
                codigo = prompt('Digite o c√≥digo de organizador para este usu√°rio:');
                if (!codigo) return;
            }

            try {
                await apiCall('usuarios', 'PUT', { CPF: cpf, Organizador: novoStatus, Codigo: codigo });
                carregarUsuarios();
            } catch (error) {
                // Erro j√° tratado na fun√ß√£o apiCall
            }
        }

        async function excluirUsuario(cpf) {
            if (confirm('Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.')) {
                try {
                    await apiCall(`usuarios&id=${cpf}`, 'DELETE');
                    carregarUsuarios();
                } catch (error) {
                    // Erro j√° tratado na fun√ß√£o apiCall
                }
            }
        }

        async function excluirEvento(id) {
            if (confirm('Tem certeza que deseja excluir este evento?')) {
                try {
                    await apiCall(`eventos&id=${id}`, 'DELETE');
                    carregarEventos();
                } catch (error) {
                    // Erro j√° tratado na fun√ß√£o apiCall
                }
            }
        }

        // =======================================
        // MODAL DE EVENTOS
        // =======================================

        function showModalEvento(eventoId = null) {
            document.getElementById('modalEvento').style.display = 'block';

            if (eventoId) {
                // Editar evento existente
                const evento = currentData.eventos.find(e => e.cod_evento == eventoId);
                if (evento) {
                    document.getElementById('modalEventoTitle').textContent = 'Editar Evento';
                    document.getElementById('cod_evento').value = evento.cod_evento;
                    document.getElementById('categoria').value = evento.categoria;
                    document.getElementById('nome').value = evento.nome;
                    document.getElementById('lugar').value = evento.lugar;
                    document.getElementById('modalidade').value = evento.modalidade;
                    document.getElementById('descricao').value = evento.descricao;
                    document.getElementById('publico_alvo').value = evento.publico_alvo;
                    document.getElementById('duracao').value = evento.duracao;
                    document.getElementById('inicio').value = evento.inicio.slice(0, 16);
                    document.getElementById('conclusao').value = evento.conclusao.slice(0, 16);
                    document.getElementById('certificado').checked = evento.certificado == 1;
                }
            } else {
                // Novo evento
                document.getElementById('modalEventoTitle').textContent = 'Novo Evento';
                document.getElementById('formEvento').reset();
            }
        }

        function fecharModalEvento() {
            document.getElementById('modalEvento').style.display = 'none';
        }

        function editarEvento(id) {
            showModalEvento(id);
        }

        // Form submission
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('formEvento').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = {};

                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Adicionar campos n√£o capturados pelo FormData
                data.cod_evento = document.getElementById('cod_evento').value;
                data.categoria = document.getElementById('categoria').value;
                data.nome = document.getElementById('nome').value;
                data.lugar = document.getElementById('lugar').value;
                data.modalidade = document.getElementById('modalidade').value;
                data.descricao = document.getElementById('descricao').value;
                data.publico_alvo = document.getElementById('publico_alvo').value;
                data.duracao = document.getElementById('duracao').value;
                data.inicio = document.getElementById('inicio').value;
                data.conclusao = document.getElementById('conclusao').value;
                data.certificado = document.getElementById('certificado').checked;

                try {
                    // Verificar se √© edi√ß√£o ou cria√ß√£o
                    const isEdit = currentData.eventos && currentData.eventos.some(e => e.cod_evento == data.cod_evento);

                    if (isEdit) {
                        await apiCall('eventos', 'PUT', data);
                    } else {
                        await apiCall('eventos', 'POST', data);
                    }

                    fecharModalEvento();
                    carregarEventos();
                    alert('Evento salvo com sucesso!');
                } catch (error) {
                    // Erro j√° tratado na fun√ß√£o apiCall
                }
            });
        });

        function exportarEventos() {
            alert('Funcionalidade de exporta√ß√£o ser√° implementada em breve.');
        }

        function exportarUsuarios() {
            alert('Funcionalidade de exporta√ß√£o ser√° implementada em breve.');
        }

        function gerarCodigosLote() {
            const quantidade = prompt('Quantos c√≥digos deseja gerar?');
            if (quantidade && parseInt(quantidade) > 0) {
                alert(`Funcionalidade de gera√ß√£o em lote ser√° implementada. Solicitado: ${quantidade} c√≥digos.`);
            }
        }

        function validarCertificados() {
            alert('Funcionalidade de valida√ß√£o ser√° implementada em breve.');
        }

        function validarCertificado(codigo) {
            alert(`Validando certificado: ${codigo}`);
        }

        // =======================================
        // FUNCIONALIDADES DE BUSCA
        // =======================================

        // Vari√°veis para controle de timeout de busca
        let timeoutBuscaUsuarios = null;
        let timeoutBuscaCodigos = null;

        // Fun√ß√£o para buscar usu√°rios
        function buscarUsuarios() {
            // Limpa timeout anterior
            if (timeoutBuscaUsuarios) {
                clearTimeout(timeoutBuscaUsuarios);
            }

            // Define novo timeout para evitar muitas requisi√ß√µes
            timeoutBuscaUsuarios = setTimeout(() => {
                const termo = document.getElementById('searchUsuarios').value.trim().toLowerCase();

                if (!currentData.usuarios) {
                    console.log('Dados de usu√°rios n√£o carregados');
                    return;
                }

                let usuariosFiltrados = currentData.usuarios;

                if (termo) {
                    usuariosFiltrados = currentData.usuarios.filter(usuario => {
                        return (
                            usuario.Nome.toLowerCase().includes(termo) ||
                            usuario.CPF.includes(termo) ||
                            usuario.Email.toLowerCase().includes(termo) ||
                            (usuario.RA && usuario.RA.includes(termo))
                        );
                    });
                }

                renderizarUsuarios(usuariosFiltrados);
            }, 300); // 300ms de delay
        }

        // Fun√ß√£o para buscar c√≥digos
        function buscarCodigos() {
            // Limpa timeout anterior
            if (timeoutBuscaCodigos) {
                clearTimeout(timeoutBuscaCodigos);
            }

            // Define novo timeout para evitar muitas requisi√ß√µes
            timeoutBuscaCodigos = setTimeout(() => {
                const termo = document.getElementById('searchCodigos').value.trim().toUpperCase();

                if (!currentData.codigos) {
                    console.log('Dados de c√≥digos n√£o carregados');
                    return;
                }

                let codigosFiltrados = currentData.codigos;

                if (termo) {
                    codigosFiltrados = currentData.codigos.filter(codigo => {
                        return (
                            codigo.codigo.includes(termo) ||
                            (codigo.observacoes && codigo.observacoes.toLowerCase().includes(termo.toLowerCase())) ||
                            (codigo.usado_por && codigo.usado_por.toLowerCase().includes(termo.toLowerCase())) ||
                            codigo.id.toString() === termo
                        );
                    });
                }

                renderizarCodigos(codigosFiltrados);
            }, 300); // 300ms de delay
        }

        // Fun√ß√£o para renderizar usu√°rios filtrados
        function renderizarUsuarios(usuarios) {
            let html = '<div class="table-responsive"><table class="data-table">';
            html += '<thead><tr><th>CPF</th><th>Nome</th><th>Email</th><th>RA</th><th>Organizador</th><th>C√≥digo</th><th>A√ß√µes</th></tr></thead><tbody>';

            if (usuarios.length === 0) {
                html += '<tr><td colspan="7" class="no-results">Nenhum usu√°rio encontrado com os crit√©rios de busca</td></tr>';
            } else {
                usuarios.forEach(usuario => {
                    const organizador = usuario.Organizador ? 'Sim' : 'N√£o';
                    const statusClass = usuario.Organizador ? 'status-ativo' : 'status-inativo';

                    html += `<tr>
                        <td>${usuario.CPF}</td>
                        <td><strong>${usuario.Nome}</strong></td>
                        <td>${usuario.Email}</td>
                        <td>${usuario.RA || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${organizador}</span></td>
                        <td>${usuario.Codigo || '-'}</td>
                        <td>
                            <button class="btn-small btn-toggle" onclick="toggleOrganizador('${usuario.CPF}', ${!usuario.Organizador})">
                                ${usuario.Organizador ? 'üë§ Remover Org' : 'üëë Tornar Org'}
                            </button>
                            <button class="btn-small btn-delete" onclick="excluirUsuario('${usuario.CPF}')">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>`;
                });
            }

            html += '</tbody></table></div>';
            html += `<div class="search-results-info">üìä Mostrando ${usuarios.length} de ${currentData.usuarios.length} usu√°rios</div>`;
            document.getElementById('usuariosContainer').innerHTML = html;
        }

        // Fun√ß√£o para renderizar c√≥digos filtrados
        function renderizarCodigos(codigos) {
            let html = '<div class="table-responsive"><table class="data-table">';
            html += '<thead><tr><th>ID</th><th>C√≥digo</th><th>Status</th><th>Usado</th><th>Data Cria√ß√£o</th><th>Usado Por</th><th>Observa√ß√µes</th><th>A√ß√µes</th></tr></thead><tbody>';

            if (codigos.length === 0) {
                html += '<tr><td colspan="8" class="no-results">Nenhum c√≥digo encontrado com os crit√©rios de busca</td></tr>';
            } else {
                codigos.forEach(codigo => {
                    const ativo = codigo.ativo == 1 ? 'Ativo' : 'Inativo';
                    const usado = codigo.usado == 1 ? 'Sim' : 'N√£o';
                    const statusClass = codigo.ativo == 1 ? (codigo.usado == 1 ? 'status-usado' : 'status-ativo') : 'status-inativo';
                    const dataCriacao = new Date(codigo.data_criacao).toLocaleDateString();

                    html += `<tr>
                        <td>${codigo.id}</td>
                        <td><strong>${codigo.codigo}</strong></td>
                        <td><span class="status-badge ${statusClass}">${ativo}</span></td>
                        <td>${usado}</td>
                        <td>${dataCriacao}</td>
                        <td>${codigo.usado_por || '-'}</td>
                        <td>${codigo.observacoes || '-'}</td>
                        <td>
                            <button class="btn-small btn-toggle" onclick="toggleCodigo(${codigo.id}, ${codigo.ativo == 1 ? 0 : 1})">
                                ${codigo.ativo == 1 ? 'üîí Desativar' : 'üîì Ativar'}
                            </button>
                            <button class="btn-small btn-delete" onclick="excluirCodigo(${codigo.id})">üóëÔ∏è Excluir</button>
                        </td>
                    </tr>`;
                });
            }

            html += '</tbody></table></div>';
            html += `<div class="search-results-info">üìä Mostrando ${codigos.length} de ${currentData.codigos.length} c√≥digos</div>`;
            document.getElementById('codigosContainer').innerHTML = html;
        }

        // Fun√ß√µes para limpar buscas
        function limparBuscaUsuarios() {
            document.getElementById('searchUsuarios').value = '';
            if (currentData.usuarios) {
                renderizarUsuarios(currentData.usuarios);
            }
        }

        function limparBuscaCodigos() {
            document.getElementById('searchCodigos').value = '';
            if (currentData.codigos) {
                renderizarCodigos(currentData.codigos);
            }
        }

        function logout() {
            if (confirm('Deseja realmente sair do sistema?')) {
                localStorage.removeItem('admin_temp_auth');
                window.location.href = 'LoginAdmin.html';
            }
        }
    </script>
</body>

</html>