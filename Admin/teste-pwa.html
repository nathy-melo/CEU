<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CEU PWA - VerificaÃ§Ã£o</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .check {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        .warning { border-left: 4px solid #ff9800; }
        .info { border-left: 4px solid #2196F3; }
        button {
            background: #6598D2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4F6C8C; }
        #results { margin-top: 20px; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ§ª CEU PWA - VerificaÃ§Ã£o de ConfiguraÃ§Ã£o</h1>
    
    <div class="check info">
        <h3>ğŸ“± Teste de ConfiguraÃ§Ã£o PWA</h3>
        <p>Esta pÃ¡gina verifica se a PWA estÃ¡ configurada corretamente.</p>
        <button onclick="runAllChecks()">ğŸ” Executar Todos os Testes</button>
        <button onclick="testInstallability()">ğŸ“± Testar InstalaÃ§Ã£o</button>
        <button onclick="clearData()">ğŸ—‘ï¸ Limpar Cache</button>
    </div>

    <div id="results"></div>

    <div class="check info">
        <h3>ğŸ“‹ InstruÃ§Ãµes de Teste Manual</h3>
        <ol>
            <li><strong>Desktop:</strong> Acesse <code>http://localhost/CEU/</code></li>
            <li><strong>Mobile (mesma rede):</strong> Descubra seu IP com <code>ipconfig</code> e acesse <code>http://SEU-IP/CEU/</code></li>
            <li><strong>Verificar PWA:</strong> F12 â†’ Application â†’ Manifest</li>
            <li><strong>Instalar:</strong> Clicar no Ã­cone de instalaÃ§Ã£o ou botÃ£o "ğŸ“± Instalar App"</li>
        </ol>
    </div>

    <script>
        function addResult(type, title, message) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `check ${type}`;
            div.innerHTML = `<h3>${title}</h3><p>${message}</p>`;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function runAllChecks() {
            clearResults();
            
            // 1. Verificar Service Worker
            if ('serviceWorker' in navigator) {
                addResult('success', 'âœ… Service Worker Suportado', 'O navegador suporta Service Workers.');
                
                try {
                    const registration = await navigator.serviceWorker.register('/CEU/sw.js');
                    addResult('success', 'âœ… Service Worker Registrado', `SW registrado em: ${registration.scope}`);
                } catch (error) {
                    addResult('error', 'âŒ Erro no Service Worker', `Erro: ${error.message}`);
                }
            } else {
                addResult('error', 'âŒ Service Worker NÃ£o Suportado', 'Este navegador nÃ£o suporta Service Workers.');
            }

            // 2. Verificar Manifest
            try {
                const response = await fetch('/CEU/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    addResult('success', 'âœ… Manifest Carregado', `Nome: ${manifest.name || manifest.short_name}`);
                } else {
                    addResult('error', 'âŒ Manifest NÃ£o Found', 'Arquivo manifest.json nÃ£o foi encontrado.');
                }
            } catch (error) {
                addResult('error', 'âŒ Erro no Manifest', `Erro ao carregar manifest: ${error.message}`);
            }

            // 3. Verificar HTTPS/Localhost
            const protocol = window.location.protocol;
            if (protocol === 'https:' || window.location.hostname === 'localhost') {
                addResult('success', 'âœ… Protocolo Seguro', `Usando ${protocol} - PWA pode ser instalada.`);
            } else {
                addResult('warning', 'âš ï¸ Protocolo Inseguro', 'PWA funciona melhor com HTTPS. Para teste local, use localhost.');
            }

            // 4. Verificar se Ã© mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            if (isMobile) {
                addResult('info', 'ğŸ“± Dispositivo Mobile Detectado', 'Teste de instalaÃ§Ã£o disponÃ­vel.');
            } else {
                addResult('info', 'ğŸ–¥ï¸ Desktop Detectado', 'Para testar no mobile, use o IP da mÃ¡quina.');
            }

            // 5. Verificar recursos PWA
            checkPWAFeatures();
        }

        function checkPWAFeatures() {
            const features = [
                { name: 'Cache API', supported: 'caches' in window },
                { name: 'Notifications', supported: 'Notification' in window },
                { name: 'Push Manager', supported: 'PushManager' in window },
                { name: 'Background Sync', supported: 'sync' in window.ServiceWorkerRegistration.prototype },
                { name: 'Install Prompt', supported: 'BeforeInstallPromptEvent' in window }
            ];

            features.forEach(feature => {
                const type = feature.supported ? 'success' : 'warning';
                const icon = feature.supported ? 'âœ…' : 'âš ï¸';
                addResult(type, `${icon} ${feature.name}`, 
                    feature.supported ? 'Suportado' : 'NÃ£o suportado neste navegador');
            });
        }

        async function testInstallability() {
            clearResults();
            
            // Verificar se evento de instalaÃ§Ã£o estÃ¡ disponÃ­vel
            if (window.deferredPrompt) {
                addResult('success', 'âœ… App Pode Ser Instalado', 'Prompt de instalaÃ§Ã£o disponÃ­vel.');
                
                try {
                    await window.deferredPrompt.prompt();
                    const choiceResult = await window.deferredPrompt.userChoice;
                    
                    if (choiceResult.outcome === 'accepted') {
                        addResult('success', 'âœ… UsuÃ¡rio Aceitou InstalaÃ§Ã£o', 'App foi instalado com sucesso!');
                    } else {
                        addResult('info', 'â„¹ï¸ UsuÃ¡rio Recusou InstalaÃ§Ã£o', 'UsuÃ¡rio optou por nÃ£o instalar.');
                    }
                } catch (error) {
                    addResult('error', 'âŒ Erro na InstalaÃ§Ã£o', `Erro: ${error.message}`);
                }
            } else {
                addResult('warning', 'âš ï¸ InstalaÃ§Ã£o NÃ£o DisponÃ­vel', 
                    'App jÃ¡ pode estar instalado ou critÃ©rios de PWA nÃ£o foram atendidos.');
            }
        }

        async function clearData() {
            try {
                // Limpar cache
                if ('caches' in window) {
                    const cacheNames = await caches.keys();
                    await Promise.all(cacheNames.map(name => caches.delete(name)));
                }
                
                // Desregistrar service workers
                if ('serviceWorker' in navigator) {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    await Promise.all(registrations.map(reg => reg.unregister()));
                }
                
                addResult('success', 'âœ… Dados Limpos', 'Cache e Service Workers removidos. Recarregue a pÃ¡gina.');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                addResult('error', 'âŒ Erro ao Limpar', `Erro: ${error.message}`);
            }
        }

        // Detectar evento de instalaÃ§Ã£o
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.deferredPrompt = e;
            addResult('info', 'ğŸ¯ Prompt de InstalaÃ§Ã£o Detectado', 'App estÃ¡ pronto para ser instalado.');
        });

        // Detectar quando app foi instalado
        window.addEventListener('appinstalled', (evt) => {
            addResult('success', 'ğŸ‰ App Instalado!', 'PWA foi instalada com sucesso no dispositivo.');
        });

        // Executar verificaÃ§Ã£o automÃ¡tica ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(runAllChecks, 1000);
        });
    </script>
</body>
</html>