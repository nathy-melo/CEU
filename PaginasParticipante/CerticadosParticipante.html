<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Certificados</title>
  <link rel="stylesheet" href="../styleGlobal.css" />
</head>
<style>
  /* CSS da seção: certificados */
  .cartao-certificados {
    max-width: 31.5rem;
    width: 100%;
    background-color: var(--branco);
    border-radius: 0.525rem;
    box-shadow: 0px 0.175rem 0.875rem 0px var(--sombra-padrao);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .cabecalho-cartao {
    background-color: var(--caixas);
    padding: 0.525rem 1.05rem;
  }

  .cabecalho-cartao h1 {
    color: var(--branco);
    font-size: clamp(1.26rem, 2.8vw, 2.1rem);
    font-weight: 700;
    text-align: center;
    margin: 0;
    text-shadow: 0px 0.175rem 0.875rem var(--sombra-padrao);
    letter-spacing: -0.085625rem;
  }

  .corpo-cartao {
    padding: 1.4rem 1.75rem;
  }

  .lista-certificados {
    display: flex;
    flex-direction: column;
    gap: 0.875rem;
  }

  .item-certificado {
    display: grid;
    grid-template-columns: 1fr auto auto auto;
    align-items: center;
    gap: 1.2rem;
  }

  .nome-item,
  .data-item {
    font-size: clamp(0.7rem, 1.4vw, 1.26rem);
    font-weight: 700;
    margin: 0 0 0 0.8rem;
    text-shadow: 0px 0.175rem 0.875rem var(--sombra-padrao);
    letter-spacing: -0.044375rem;
    color: var(--azul-escuro);
  }

  .nome-item {
    min-width: 0;
  }

  .data-item {
    white-space: nowrap;
  }

  .acoes-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    justify-self: end;
    width: fit-content;
  }

  .botao {
    display: inline-block;
    background-color: var(--caixas);
    color: var(--branco);
    font-family: 'Inter', sans-serif;
    font-weight: 700;
    font-size: clamp(0.6125rem, 1.05vw, 1.05rem);
    text-align: center;
    text-decoration: none;
    border: none;
    border-radius: 0.13125rem;
    padding: 0.4375rem 0.875rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
    letter-spacing: -0.039375rem;
    white-space: nowrap;
  }

  .botao:hover {
    opacity: 0.9;
  }

  .botao-ver {
    padding: 0.4375rem 1.05rem;
  }

  .alerta-item {
    color: var(--vermelho);
    font-size: clamp(0.7rem, 1.4vw, 1.26rem);
    font-weight: 700;
    text-shadow: 0px 0.175rem 0.875rem var(--sombra-padrao);
    justify-self: end;
    width: 0.01rem;
    text-align: center;
  }

  .paginacao {
    display: flex;
    justify-content: center;
    margin-top: 1.05rem;
  }

  .botao-paginacao {
    padding: 0.175rem 1.4rem;
  }
</style>

<body>
  <script>
    // Busca e renderiza os certificados do participante autenticado
    document.addEventListener('DOMContentLoaded', async function() {
      const listaCertificados = document.getElementById('listaCertificados');
      const mensagemCarregando = document.getElementById('mensagemCarregando');
      const mensagemVazio = document.getElementById('mensagemVazio');

      try {
        const res = await fetch('BuscarCertificadosParticipante.php');
        const dados = await res.json();

        mensagemCarregando.style.display = 'none';

        if (!dados.sucesso) {
          mensagemVazio.textContent = dados.mensagem || 'Erro ao carregar certificados.';
          mensagemVazio.style.display = 'block';
          return;
        }

        if (!dados.certificados || dados.certificados.length === 0) {
          mensagemVazio.style.display = 'block';
          return;
        }

        // Renderizar cada certificado
        dados.certificados.forEach(cert => {
          const item = document.createElement('div');
          item.className = 'item-certificado';

          // Nome do evento (clicável para abrir a página do evento)
          const nomeEvento = document.createElement('p');
          nomeEvento.className = 'nome-item';
          nomeEvento.style.cursor = 'pointer';
          nomeEvento.style.textDecoration = 'underline';
          nomeEvento.textContent = cert.nome_evento;
          nomeEvento.title = 'Clique para ver detalhes do evento';
          nomeEvento.onclick = () => {
            window.location.href = `ContainerParticipante.php?pagina=eventoInscrito&cod_evento=${cert.cod_evento}`;
          };

          // Data
          const data = document.createElement('p');
          data.className = 'data-item';
          data.textContent = cert.data_conclusao;

          // Status e ações
          const acoes = document.createElement('div');
          acoes.className = 'acoes-item';

          if (cert.emitido) {
            // Certificado já emitido: botões baixar e ver
            const btnBaixar = document.createElement('a');
            btnBaixar.className = 'botao';
            btnBaixar.textContent = 'Baixar';
            btnBaixar.href = `../Certificacao/ver_certificado.php?codigo=${encodeURIComponent(cert.codigo_verificacao)}`;
            btnBaixar.download = `certificado_${cert.nome_evento.replace(/\s+/g, '_')}.pdf`;

            const btnVer = document.createElement('a');
            btnVer.className = 'botao botao-ver';
            btnVer.textContent = 'Ver';
            btnVer.href = `../Certificacao/VerificarCertificacao.php?codigo=${encodeURIComponent(cert.codigo_verificacao)}`;
            btnVer.target = '_blank';

            acoes.appendChild(btnBaixar);
            acoes.appendChild(btnVer);
          } else {
            // Certificado não emitido: botão para gerar
            const btnGerar = document.createElement('button');
            btnGerar.className = 'botao';
            btnGerar.textContent = 'Gerar Certificado';
            btnGerar.style.gridColumn = 'span 2';
            btnGerar.onclick = async () => {
              btnGerar.disabled = true;
              btnGerar.textContent = 'Gerando...';
              try {
                // Buscar CPF da sessão via endpoint auxiliar ou assumir que está disponível
                const urlGerar = `../Certificacao/GerarCertificadoParticipante.php?cod_evento=${cert.cod_evento}`;
                const resGerar = await fetch(urlGerar);
                const dadosGerar = await resGerar.json();
                if (dadosGerar.sucesso) {
                  alert('Certificado gerado com sucesso!');
                  location.reload();
                } else {
                  alert(dadosGerar.mensagem || 'Erro ao gerar certificado.');
                  btnGerar.disabled = false;
                  btnGerar.textContent = 'Gerar Certificado';
                }
              } catch (e) {
                alert('Erro ao gerar certificado. Tente novamente.');
                btnGerar.disabled = false;
                btnGerar.textContent = 'Gerar Certificado';
              }
            };
            acoes.appendChild(btnGerar);
          }

          // Alerta (! se não emitido, vazio se emitido)
          const alerta = document.createElement('span');
          alerta.className = 'alerta-item';
          alerta.textContent = cert.emitido ? '' : '!';
          alerta.title = cert.emitido ? '' : 'Certificado ainda não foi emitido';

          item.appendChild(nomeEvento);
          item.appendChild(data);
          item.appendChild(acoes);
          item.appendChild(alerta);

          listaCertificados.appendChild(item);
        });

        listaCertificados.style.display = 'flex';
      } catch (erro) {
        console.error('Erro ao carregar certificados:', erro);
        mensagemCarregando.style.display = 'none';
        mensagemVazio.textContent = 'Erro ao carregar certificados. Tente novamente mais tarde.';
        mensagemVazio.style.display = 'block';
      }
    });
  </script>
  <div id="main-content">
    <div class="cartao-certificados">
      <header class="cabecalho-cartao">
        <h1>Certificados</h1>
      </header>
      <div class="corpo-cartao">
        <div id="mensagemCarregando" style="text-align: center; padding: 2rem; color: var(--azul-escuro);">
          Carregando certificados...
        </div>
        <div id="mensagemVazio" style="display: none; text-align: center; padding: 2rem; color: var(--azul-escuro);">
          Nenhum certificado disponível no momento.
        </div>
        <div id="listaCertificados" class="lista-certificados" style="display: none;">
        </div>
      </div>
    </div>
  </div>
</body>

</html>